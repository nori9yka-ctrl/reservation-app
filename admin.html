<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Renta ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f7f6; padding: 0; margin: 0; color: #333; padding-bottom: 80px; }
    h2 { color: #06C755; margin: 0; font-size: 1.2rem; }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
    .nav-bar { position: fixed; top: 0; left: 0; width: 100%; background: #fff; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; }
    .nav-item { flex: 1; text-align: center; padding: 15px 0; cursor: pointer; font-weight: bold; color: #888; border-bottom: 3px solid transparent; font-size: 0.9rem; }
    .nav-item.active { color: #06C755; border-bottom: 3px solid #06C755; background: #f9fff9; }

    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
    .content-section { display: none; padding: 80px 20px 20px 20px; max-width: 900px; margin: 0 auto; }
    .content-section.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ã‚«ãƒ¼ãƒ‰ãƒ»ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
    .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; }
    .res-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .res-item:hover { background: #fafafa; }
    .res-date { font-size: 0.8rem; color: #888; }
    .res-name { font-weight: bold; font-size: 1.05rem; }
    .res-bike { color: #06C755; font-size: 0.9rem; font-weight: bold; }
    .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555; margin-left: 5px; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« (ãƒã‚¹ã‚¿ç®¡ç†ç”¨) */
    .master-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .master-table th { text-align: left; padding: 10px; background: #f0f0f0; border-bottom: 2px solid #ddd; }
    .master-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .thumb-img { width: 50px; height: 35px; object-fit: cover; border-radius: 4px; background: #eee; }

    /* ãƒœã‚¿ãƒ³ */
    .btn { padding: 10px 20px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; display: inline-block; text-align: center; }
    .btn-primary { background: #06C755; color: white; width: 100%; }
    .btn-danger { background: #ff4b4b; color: white; font-size: 0.8rem; padding: 5px 10px; border-radius: 5px; }
    .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; }
    .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background: #06C755; color: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; z-index: 900; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #modal, #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
    .modal-header { font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; border-bottom: 2px solid #06C755; padding-bottom: 10px; display: flex; justify-content: space-between; }

    /* è©³ç´°è¡¨ç¤º */
    .detail-row { margin-bottom: 10px; display: flex; border-bottom: 1px solid #f9f9f9; padding-bottom: 5px; }
    .detail-label { width: 100px; font-weight: bold; color: #666; font-size: 0.9rem; }
    .detail-val { flex: 1; word-break: break-all; }
    
    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
    
    /* ãƒ¡ãƒ¼ãƒ«ãƒ»é›»è©±ã‚¨ãƒªã‚¢ */
    .action-area { margin-top: 20px; background: #f8f8f8; padding: 15px; border-radius: 8px; }
    .action-title { font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; color: #06C755; }
    .phone-display { font-size: 1.5rem; font-weight: bold; color: #333; text-align: center; background: white; padding: 10px; border-radius: 5px; border: 2px solid #eee; letter-spacing: 1px; }

    .mail-history { margin-top: 10px; max-height: 150px; overflow-y: scroll; border: 1px solid #eee; padding: 5px; background: white; }
    .mail-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
    .mail-unread { background: #e6fffa; border-left: 3px solid #06C755; }
  </style>
</head>
<body>

  <div class="nav-bar">
    <div class="nav-item active" onclick="switchTab('res')">äºˆç´„ä¸€è¦§</div>
    <div class="nav-item" onclick="switchTab('bikes')">è»Šä¸¡ãƒã‚¹ã‚¿</div>
    <div class="nav-item" onclick="switchTab('options')">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
  </div>

  <div id="sec-res" class="content-section active">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2>äºˆç´„ãƒªã‚¹ãƒˆ</h2>
        <button class="btn btn-sm" style="background:#ddd;" onclick="loadBookings()">æ›´æ–°</button>
      </div>
      <div id="list-area">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

  <div id="sec-bikes" class="content-section">
    <div class="card">
      <h2>è»Šä¸¡ãƒªã‚¹ãƒˆ</h2>
      <div style="overflow-x:auto;">
        <table class="master-table">
          <thead><tr><th>ç”»åƒ</th><th>è»Šä¸¡å</th><th>ã‚¯ãƒ©ã‚¹</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="bike-list-body"></tbody>
        </table>
      </div>
      <div style="text-align:center; padding:20px; color:#888;" id="bike-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    <div class="fab" onclick="showAddBikeModal()">ï¼‹</div>
  </div>

  <div id="sec-options" class="content-section">
    <div class="card">
      <h2>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ</h2>
      <table class="master-table">
        <thead><tr><th>åç§°</th><th>24hä¾¡æ ¼</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="opt-list-body"></tbody>
      </table>
      <div style="text-align:center; padding:20px; color:#888;" id="opt-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    <div class="fab" onclick="showAddOptModal()">ï¼‹</div>
  </div>


  <div id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>äºˆç´„è©³ç´°</span>
        <span style="cursor:pointer;" onclick="closeModal('modal')">Ã—</span>
      </div>
      <div id="modal-body"></div>
      
      <div class="action-area">
        <div class="action-title">ğŸ“© å—ä¿¡ãƒ¡ãƒ¼ãƒ«å±¥æ­´</div>
        <div id="mail-list" class="mail-history">èª­ã¿è¾¼ã¿ä¸­...</div>
        <button class="btn btn-sm" style="background:#ddd; width:100%; margin-top:5px;" onclick="loadMails()">æ›´æ–°</button>
      </div>

      <div class="action-area">
        <div class="action-title">ğŸ“ é›»è©±ç•ªå·</div>
        <div id="phone-display" class="phone-display"></div>
        <div style="text-align:center; font-size:0.8rem; color:#888; margin-top:5px;">â€»ç•ªå·ã‚’è¦‹ã¦æ‰‹å‹•ã§ç™ºä¿¡ã—ã¦ãã ã•ã„</div>
      </div>

      <div class="action-area">
        <div class="action-title">âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡</div>
        <div id="email-form">
          <input type="text" id="mail-subject" placeholder="ä»¶å" value="ã€Rentaã€‘ã”äºˆç´„ã«ã¤ã„ã¦">
          <textarea id="mail-body" placeholder="æœ¬æ–‡..."></textarea>
          <button class="btn btn-primary" onclick="sendMail()">é€ä¿¡ã™ã‚‹</button>
        </div>
        <div id="no-email-msg" style="color:red; display:none;">â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æœªç™»éŒ²</div>
      </div>
    </div>
  </div>


  <div id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <span id="edit-title">è¿½åŠ </span>
        <span style="cursor:pointer;" onclick="closeModal('editModal')">Ã—</span>
      </div>
      <div id="edit-form-container"></div>
    </div>
  </div>


  <script>
    // â˜…é‡è¦ï¼šGASã®URLã‚’ã“ã“ã«è²¼ã‚‹
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxWvKydNXGLMLBDXLkigRBnJJeJgRLttFlruTFbDLCFNaKagLONSf_9JOT9hXjFaup_9w/exec";

    let currentData = null;
    let priceClasses = []; // æ–™é‡‘ã‚¯ãƒ©ã‚¹ãƒªã‚¹ãƒˆ

    // é€šä¿¡å…±é€šé–¢æ•°
    function callGas(action, params = {}) {
      return fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: action, ...params })
      }).then(response => response.json());
    }

    window.onload = function() {
      loadBookings(); // åˆæœŸè¡¨ç¤º
      // æ–™é‡‘ã‚¯ãƒ©ã‚¹ã ã‘å…ˆã«å–ã£ã¦ãŠã
      callGas("get_price_classes").then(res => { if(res.result==='success') priceClasses = res.data; });
    };

    // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
    function switchTab(tab) {
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
      
      if(tab === 'res') {
        document.querySelector('.nav-item:nth-child(1)').classList.add('active');
        document.getElementById('sec-res').classList.add('active');
        loadBookings();
      } else if(tab === 'bikes') {
        document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        document.getElementById('sec-bikes').classList.add('active');
        loadMasters();
      } else {
        document.querySelector('.nav-item:nth-child(3)').classList.add('active');
        document.getElementById('sec-options').classList.add('active');
        loadOptions();
      }
    }

    // ==========================================
    // 1. äºˆç´„ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    function loadBookings() {
      document.getElementById('list-area').innerHTML = '<div style="text-align:center; padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      callGas("get_bookings_admin").then(res => {
        if(res.result !== 'success') return alert("ã‚¨ãƒ©ãƒ¼");
        const list = document.getElementById('list-area');
        list.innerHTML = "";
        res.data.forEach(d => {
          const div = document.createElement('div');
          div.className = 'res-item';
          div.innerHTML = `
            <div class="res-info">
              <div class="res-date">${d.date} | ${d.range}</div>
              <div class="res-name">${d.name} æ§˜ <span class="status-badge">${d.status}</span></div>
              <div class="res-bike">ğŸ ${d.bike}</div>
            </div>
            <div style="color:#ccc;">ï¼</div>
          `;
          div.onclick = () => openBookingModal(d);
          list.appendChild(div);
        });
      }).catch(e => alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"));
    }

    function openBookingModal(d) {
      currentData = d;
      const b = document.getElementById('modal-body');
      b.innerHTML = `
        <div class="detail-row"><div class="detail-label">åå‰</div><div class="detail-val">${d.name}</div></div>
        <div class="detail-row"><div class="detail-label">é›»è©±</div><div class="detail-val">${d.phone}</div></div>
        <div class="detail-row"><div class="detail-label">ä½æ‰€</div><div class="detail-val">${d.address}</div></div>
        <div class="detail-row"><div class="detail-label">æœŸé–“</div><div class="detail-val">${d.range}</div></div>
        <div class="detail-row"><div class="detail-label">è»Šä¸¡</div><div class="detail-val">${d.bike}</div></div>
        <div class="detail-row"><div class="detail-label">é‡‘é¡</div><div class="detail-val">${d.price}</div></div>
        <div class="detail-row"><div class="detail-label">å‚™è€ƒ</div><div class="detail-val">${d.memo || '-'}</div></div>
      `;
      
      // â˜…ä¿®æ­£ç®‡æ‰€ï¼šé›»è©±ç•ªå·ã‚’è¡¨ç¤ºã®ã¿ã«ã™ã‚‹
      document.getElementById('phone-display').innerText = d.phone;

      // ãƒ¡ãƒ¼ãƒ«åˆ¶å¾¡
      if(d.email && d.email.includes('@')) {
        document.getElementById('email-form').style.display = 'block';
        document.getElementById('no-email-msg').style.display = 'none';
        document.getElementById('mail-body').value = `${d.name} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\nRentaã®ã€‡ã€‡ã§ã™ã€‚\n\n`;
        loadMails();
      } else {
        document.getElementById('email-form').style.display = 'none';
        document.getElementById('no-email-msg').style.display = 'block';
        document.getElementById('mail-list').innerHTML = '<div style="padding:10px; color:#888;">ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã—</div>';
      }
      document.getElementById('modal').style.display = 'flex';
    }

    function loadMails() {
      const area = document.getElementById('mail-list');
      area.innerHTML = 'æ¤œç´¢ä¸­...';
      callGas("get_customer_emails", { email: currentData.email }).then(res => {
        if(res.result === 'success') {
          if(res.data.length === 0) area.innerHTML = '<div style="padding:10px; color:#888;">å±¥æ­´ãªã—</div>';
          else {
            area.innerHTML = "";
            res.data.forEach(m => {
              const div = document.createElement('div');
              div.className = 'mail-item' + (m.isUnread ? ' mail-unread' : '');
              div.innerHTML = `<div style="font-size:0.7rem; color:#888;">${m.date}</div><div style="font-weight:bold;">${m.subject}</div><div style="font-size:0.8rem;">${m.body}</div>`;
              area.appendChild(div);
            });
          }
        } else { area.innerHTML = 'ã‚¨ãƒ©ãƒ¼'; }
      });
    }

    function sendMail() {
      if(!confirm("é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")) return;
      const sub = document.getElementById('mail-subject').value;
      const body = document.getElementById('mail-body').value;
      callGas("send_custom_email", { to: currentData.email, subject: sub, body: body }).then(r => {
        if(r.result === 'success') { alert("é€ä¿¡å®Œäº†"); document.getElementById('modal').style.display='none'; }
        else alert("å¤±æ•—: "+r.message);
      });
    }

    // ==========================================
    // 2. è»Šä¸¡ãƒã‚¹ã‚¿ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    function loadMasters() {
      document.getElementById('bike-loading').style.display = 'block';
      document.getElementById('bike-list-body').innerHTML = '';
      callGas("get_master_list").then(res => {
        document.getElementById('bike-loading').style.display = 'none';
        const tb = document.getElementById('bike-list-body');
        if(res.result === 'success') {
          res.data.forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><img src="${b.image || 'https://via.placeholder.com/50'}" class="thumb-img"></td>
              <td>${b.name}<br><span style="font-size:0.7rem; color:#888;">${b.category}</span></td>
              <td>${b.className}</td>
              <td><button class="btn btn-danger btn-sm" onclick="delMaster(${b.rowIndex})">å‰Šé™¤</button></td>
            `;
            tb.appendChild(tr);
          });
        }
      });
    }

    function showAddBikeModal() {
      document.getElementById('edit-title').innerText = "è»Šä¸¡ã‚’è¿½åŠ ";
      let opts = "";
      priceClasses.forEach(p => opts += `<option value="${p.name}">${p.name}</option>`);
      
      document.getElementById('edit-form-container').innerHTML = `
        <label>ã‚«ãƒ†ã‚´ãƒª (ä¾‹: HONDA)</label><input type="text" id="in-cat">
        <label>è»Šä¸¡å</label><input type="text" id="in-name">
        <label>æ–™é‡‘ã‚¯ãƒ©ã‚¹</label><select id="in-class">${opts}</select>
        <label>ç”»åƒ</label><input type="file" id="in-file">
        <button class="btn btn-primary" onclick="submitBike()">ç™»éŒ²ã™ã‚‹</button>
      `;
      document.getElementById('editModal').style.display = 'flex';
    }

    function submitBike() {
      const cat = document.getElementById('in-cat').value;
      const name = document.getElementById('in-name').value;
      const cls = document.getElementById('in-class').value;
      const file = document.getElementById('in-file').files[0];

      if(!cat || !name || !file) return alert("å…¨é …ç›®å¿…é ˆã§ã™");

      const reader = new FileReader();
      reader.onloadend = function() {
        const base64 = reader.result; // data:image/jpeg;base64,...
        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -> ãƒã‚¹ã‚¿è¿½åŠ ã®é †ã§å®Ÿè¡Œ
        const btn = event.target; btn.disabled=true; btn.innerText="é€ä¿¡ä¸­...";
        
        callGas("upload_image", { imageData: base64, mimeType: file.type, fileName: file.name }).then(res1 => {
          if(res1.result === 'success') {
            return callGas("add_master", { category: cat, name: name, className: cls, image: res1.url });
          } else throw new Error("ç”»åƒã‚¢ãƒƒãƒ—å¤±æ•—");
        }).then(res2 => {
          if(res2.result === 'success') {
            alert("ç™»éŒ²ã—ã¾ã—ãŸ");
            closeModal('editModal');
            loadMasters();
          }
        }).catch(e => alert("ã‚¨ãƒ©ãƒ¼: " + e));
      }
      reader.readAsDataURL(file);
    }

    function delMaster(idx) {
      if(confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        callGas("delete_master", { rowIndex: idx }).then(() => loadMasters());
      }
    }

    // ==========================================
    // 3. ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    function loadOptions() {
      document.getElementById('opt-loading').style.display = 'block';
      document.getElementById('opt-list-body').innerHTML = '';
      callGas("get_option_list").then(res => {
        document.getElementById('opt-loading').style.display = 'none';
        const tb = document.getElementById('opt-list-body');
        if(res.result === 'success') {
          res.data.forEach(o => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${o.name}</td>
              <td>Â¥${o.p24}</td>
              <td><button class="btn btn-danger btn-sm" onclick="delOption(${o.rowIndex})">å‰Šé™¤</button></td>
            `;
            tb.appendChild(tr);
          });
        }
      });
    }

    function showAddOptModal() {
      document.getElementById('edit-title').innerText = "ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ";
      document.getElementById('edit-form-container').innerHTML = `
        <label>åç§°</label><input type="text" id="op-name">
        <label>4æ™‚é–“æ–™é‡‘</label><input type="number" id="op-p4">
        <label>8æ™‚é–“æ–™é‡‘</label><input type="number" id="op-p8">
        <label>24æ™‚é–“æ–™é‡‘</label><input type="number" id="op-p24">
        <label>ä»¥å¾Œ1æ—¥æ–™é‡‘</label><input type="number" id="op-add">
        <label>èª¬æ˜(ä»»æ„)</label><textarea id="op-desc"></textarea>
        <button class="btn btn-primary" onclick="submitOption()">ç™»éŒ²ã™ã‚‹</button>
      `;
      document.getElementById('editModal').style.display = 'flex';
    }

    function submitOption() {
      const d = {
        name: document.getElementById('op-name').value,
        p4: document.getElementById('op-p4').value,
        p8: document.getElementById('op-p8').value,
        p24: document.getElementById('op-p24').value,
        pAdd: document.getElementById('op-add').value,
        desc: document.getElementById('op-desc').value
      };
      if(!d.name || !d.p24) return alert("åç§°ã¨24æ™‚é–“æ–™é‡‘ã¯å¿…é ˆã§ã™");
      
      callGas("add_option", d).then(res => {
        if(res.result === 'success') {
          alert("è¿½åŠ ã—ã¾ã—ãŸ");
          closeModal('editModal');
          loadOptions();
        }
      });
    }

    function delOption(idx) {
      if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        callGas("delete_option", { rowIndex: idx }).then(() => loadOptions());
      }
    }

    // å…±é€š: ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  </script>
</body>
</html>
