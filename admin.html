<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>äºˆç´„ç®¡ç†ç”»é¢</title>
  <style>
    /* ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š */
    body { font-family: sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
    h2 { color: #06C755; text-align: center; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    
    .res-item { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
    .res-item:hover { background: #f9fff9; }
    .res-info { flex: 1; }
    .res-date { font-size: 0.85rem; color: #888; margin-bottom: 4px; }
    .res-name { font-weight: bold; font-size: 1.1rem; }
    .res-bike { color: #06C755; font-size: 0.9rem; }
    .status-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; background: #eee; color: #555; }
    
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
    .modal-header { font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; border-bottom: 2px solid #06C755; padding-bottom: 10px; }
    
    .detail-row { margin-bottom: 10px; display: flex; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
    .detail-label { width: 100px; font-weight: bold; color: #666; font-size: 0.9rem; }
    .detail-val { flex: 1; word-break: break-all; }
    
    .action-area { margin-top: 20px; background: #f8f8f8; padding: 15px; border-radius: 8px; }
    .action-title { font-weight: bold; margin-bottom: 10px; font-size: 0.9rem; color: #06C755; }
    
    textarea { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 5px; padding: 8px; margin-bottom: 10px; font-family: sans-serif; }
    input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
    
    .btn { padding: 10px 20px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
    .btn-close { background: #666; color: white; margin-top: 15px; }
    .btn-send { background: #06C755; color: white; }
    .btn-tel { background: #333; color: white; display: block; text-decoration: none; text-align: center; padding: 10px; border-radius: 20px; font-weight: bold; }

    .mail-history { margin-top: 10px; max-height: 150px; overflow-y: scroll; border: 1px solid #eee; padding: 5px; background: white; }
    .mail-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
    .mail-date { color: #888; font-size: 0.75rem; }
    .mail-subject { font-weight: bold; color: #333; }
    .mail-unread { background: #e6fffa; border-left: 3px solid #06C755; }
  </style>
</head>
<body>

  <div class="container">
    <h2>äºˆç´„ãƒªã‚¹ãƒˆ</h2>
    <div id="list-area">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <div id="modal">
    <div class="modal-content">
      <div class="modal-header">ãŠå®¢æ§˜æƒ…å ±</div>
      <div id="modal-body"></div>
      
      <div class="action-area">
        <div class="action-title">ğŸ“© ã“ã®ãŠå®¢æ§˜ã‹ã‚‰ã®å—ä¿¡ãƒ¡ãƒ¼ãƒ«</div>
        <div id="mail-list" class="mail-history">èª­ã¿è¾¼ã¿ä¸­...</div>
        <button class="btn" style="background:#ddd; font-size:0.8rem; margin-top:5px;" onclick="loadMails()">å†èª­ã¿è¾¼ã¿</button>
      </div>

      <div class="action-area">
        <div class="action-title">ğŸ“ é›»è©±ã§é€£çµ¡</div>
        <a href="#" id="tel-link" class="btn-tel">é›»è©±ã‚’ã‹ã‘ã‚‹</a>
      </div>

      <div class="action-area">
        <div class="action-title">âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡</div>
        <div id="email-form">
          <input type="text" id="mail-subject" placeholder="ä»¶å" value="ã€Rentaã€‘ã”äºˆç´„ã«ã¤ã„ã¦">
          <textarea id="mail-body" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."></textarea>
          <button class="btn btn-send" onclick="sendMail()">é€ä¿¡ã™ã‚‹</button>
        </div>
        <div id="no-email-msg" style="color:red; display:none; font-size:0.9rem;">â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
      </div>

      <button class="btn btn-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    // â˜…é‡è¦ï¼šã“ã“ã«GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxWvKydNXGLMLBDXLkigRBnJJeJgRLttFlruTFbDLCFNaKagLONSf_9JOT9hXjFaup_9w/exec";

    let currentData = null;

    // GASã¨ã®é€šä¿¡ç”¨é–¢æ•° (Webç‰ˆã¨åŒã˜ä»•çµ„ã¿)
    function callGas(action, params = {}) {
      return fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: action, ...params })
      }).then(response => response.json());
    }

    window.onload = function() { loadBookings(); };

    function loadBookings() {
      callGas("get_bookings_admin")
        .then(renderList)
        .catch(e => alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e));
    }

    function renderList(res) {
      if(res.result !== 'success') return alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼");
      const list = document.getElementById('list-area');
      list.innerHTML = "";
      res.data.forEach((d, i) => {
        const div = document.createElement('div');
        div.className = 'res-item';
        div.innerHTML = `
          <div class="res-info">
            <div class="res-date">${d.date} | ${d.range}</div>
            <div class="res-name">${d.name} æ§˜ <span class="status-badge">${d.status}</span></div>
            <div class="res-bike">ğŸ ${d.bike}</div>
          </div>
          <div>ï¼</div>
        `;
        div.onclick = () => openModal(d);
        list.appendChild(div);
      });
    }

    function openModal(d) {
      currentData = d;
      const b = document.getElementById('modal-body');
      
      b.innerHTML = `
        <div class="detail-row"><div class="detail-label">ãŠåå‰</div><div class="detail-val">${d.name}</div></div>
        <div class="detail-row"><div class="detail-label">é›»è©±ç•ªå·</div><div class="detail-val">${d.phone}</div></div>
        <div class="detail-row"><div class="detail-label">ä½æ‰€</div><div class="detail-val">${d.address}</div></div>
        <div class="detail-row"><div class="detail-label">ãƒ¡ãƒ¼ãƒ«</div><div class="detail-val">${d.email || '(æœªç™»éŒ²)'}</div></div>
        <div class="detail-row"><div class="detail-label">å‚™è€ƒ</div><div class="detail-val">${d.memo || 'ãªã—'}</div></div>
        <div class="detail-row"><div class="detail-label">é‡‘é¡</div><div class="detail-val">${d.price}</div></div>
      `;

      document.getElementById('tel-link').href = `tel:${d.phone.replace(/-/g,'')}`;

      if(d.email && d.email.includes('@')) {
        document.getElementById('email-form').style.display = 'block';
        document.getElementById('no-email-msg').style.display = 'none';
        document.getElementById('mail-body').value = `${d.name} æ§˜\n\nãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\nRentaã®ã€‡ã€‡ã§ã™ã€‚\n\n`;
        // ãƒ¡ãƒ¼ãƒ«å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
        loadMails();
      } else {
        document.getElementById('email-form').style.display = 'none';
        document.getElementById('no-email-msg').style.display = 'block';
        document.getElementById('mail-list').innerHTML = '<div style="padding:10px; color:#888;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }

      document.getElementById('modal').style.display = 'flex';
    }

    function loadMails() {
      const area = document.getElementById('mail-list');
      area.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';
      
      callGas("get_customer_emails", { email: currentData.email })
        .then(res => {
          if(res.result === 'success') {
            if(res.data.length === 0) {
              area.innerHTML = '<div style="padding:10px; color:#888;">å—ä¿¡å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
              area.innerHTML = "";
              res.data.forEach(m => {
                const div = document.createElement('div');
                div.className = 'mail-item' + (m.isUnread ? ' mail-unread' : '');
                div.innerHTML = `<div class="mail-date">${m.date}</div><div class="mail-subject">${m.subject}</div><div style="font-size:0.8rem; color:#555;">${m.body}</div>`;
                area.appendChild(div);
              });
            }
          } else {
            area.innerHTML = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + res.message;
          }
        })
        .catch(e => { area.innerHTML = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼'; });
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function sendMail() {
      if(!confirm("ã“ã®å†…å®¹ã§ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")) return;
      const sub = document.getElementById('mail-subject').value;
      const body = document.getElementById('mail-body').value;
      
      callGas("send_custom_email", { to: currentData.email, subject: sub, body: body })
        .then(r => {
          if(r.result === 'success') { alert("é€ä¿¡ã—ã¾ã—ãŸï¼"); closeModal(); } 
          else { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + r.message); }
        })
        .catch(e => alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"));
    }
  </script>
</body>
</html>
