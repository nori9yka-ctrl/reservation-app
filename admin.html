<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¬ãƒ³ã‚¿ãƒ«ãƒã‚¤ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
  
  <style>
    /* --- åŸºæœ¬è¨­å®š --- */
    body { margin: 0; font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; color: #333; display: flex; height: 100vh; }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar { width: 250px; background-color: #343a40; color: white; display: flex; flex-direction: column; flex-shrink: 0; }
    .sidebar-header { padding: 20px; font-size: 1.2rem; font-weight: bold; background-color: #06C755; text-align: center; }
    .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #4b545c; transition: 0.3s; }
    .nav-item:hover, .nav-item.active { background-color: #495057; border-left: 4px solid #06C755; }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    .main { flex-grow: 1; padding: 20px; overflow-y: auto; }
    
    /* å…±é€šãƒ‘ãƒ¼ãƒ„ */
    .btn { padding: 8px 16px; background: #06C755; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .btn-sm { padding: 4px 10px; font-size: 0.85rem; margin-right: 5px; }
    .btn-print { background: #333; }
    .view-section { display: none; }
    .view-section.active { display: block; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: #f8f9fa; color: #555; }

    /* --- ğŸ“ è²¸æ¸¡è¨¼ï¼ˆå¸³ç¥¨ï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
    .sheet-container {
      background: white; width: 210mm; min-height: 297mm; padding: 15mm; 
      margin: 0 auto; box-shadow: 0 0 15px rgba(0,0,0,0.1); box-sizing: border-box;
      position: relative;
    }
    .sheet-title { text-align: center; font-size: 16pt; border-bottom: 3px double #333; padding-bottom: 5px; margin-bottom: 15px; }
    .sheet-section { background-color: #333; color: #fff; padding: 3px 10px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; font-size: 11pt; }
    .sheet-box { border: 2px solid #000; padding: 10px; font-size: 10pt; }
    .sheet-row { display: flex; gap: 15px; margin-bottom: 8px; align-items: flex-end; }
    .sheet-col { flex: 1; }
    .sheet-label { font-size: 9pt; font-weight: bold; display: block; margin-bottom: 2px; color: #555; }
    
    /* é‡è¦ï¼šæ›¸ãè¾¼ã‚ã‚‹å…¥åŠ›æ¬„ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .sheet-input {
      width: 100%; border: none; border-bottom: 1px solid #333; 
      background: #fdfdfd; font-size: 11pt; padding: 2px 5px; 
      font-family: inherit; color: #000; outline: none; transition: 0.2s;
    }
    .sheet-input:focus { background: #e8f0fe; border-bottom: 2px solid #06C755; }
    
    /* å°åˆ·æ™‚ã®è¨­å®šï¼ˆã“ã“ãŒãƒŸã‚½ã§ã™ï¼ï¼‰ */
    @media print {
      body { background: white; height: auto; display: block; }
      .sidebar, .no-print { display: none !important; } /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™ */
      .main { padding: 0; overflow: visible; }
      .sheet-container { box-shadow: none; margin: 0; padding: 0; width: 100%; }
      .sheet-input { background: transparent !important; border-bottom: 1px solid #000 !important; }
      /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®è‰²ã‚‚æ¶ˆã™ */
      .sheet-input:focus { border-bottom: 1px solid #000 !important; }
      .view-section { display: none; }
      #sheet-view { display: block !important; } /* å¸³ç¥¨ã ã‘è¡¨ç¤º */
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header">ç®¡ç†ç”»é¢</div>
    <div class="nav-item active" onclick="switchView('bookings')">ğŸ“‹ äºˆç´„ãƒªã‚¹ãƒˆ</div>
    <div class="nav-item" onclick="switchView('sheet-view')" id="nav-sheet" style="display:none;">ğŸ“ è²¸æ¸¡è¨¼ä½œæˆ</div>
    <div class="nav-item" onclick="switchView('calendar')">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
  </div>

  <div class="main">
    
    <div id="bookings" class="view-section active">
      <h2 class="page-title">å…¨äºˆç´„ãƒªã‚¹ãƒˆ</h2>
      <div style="background:white; padding:20px; border-radius:8px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <input type="text" placeholder="åå‰æ¤œç´¢..." style="padding:8px; border:1px solid #ddd; width:200px;">
          <button class="btn" onclick="fetchBookings()">ğŸ”„ ãƒªã‚¹ãƒˆæ›´æ–°</button>
        </div>
        <p id="loading-msg" style="display:none;">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p>
        <table>
          <thead>
            <tr><th>æ—¥æ™‚</th><th>åå‰</th><th>ãƒã‚¤ã‚¯</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="booking-list-body"></tbody>
        </table>
      </div>
    </div>

    <div id="calendar" class="view-section">
      <div style="background:white; padding:20px;"><div id='calendar-el'></div></div>
    </div>

    <div id="sheet-view" class="view-section">
      
      <div class="no-print" style="margin-bottom:20px; text-align:center; position:sticky; top:0; z-index:100; background:#f4f6f9; padding:10px;">
        <button class="btn btn-print" onclick="window.print()" style="font-size:1.2rem; padding:10px 30px;">ğŸ–¨ å°åˆ·ã™ã‚‹</button>
        <button class="btn" onclick="saveSheetData()" id="btn-save" style="font-size:1.2rem; padding:10px 30px; margin-left:20px;">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
        <button class="btn" onclick="switchView('bookings')" style="background:#666; margin-left:20px;">æˆ»ã‚‹</button>
        <div style="margin-top:5px; font-size:0.9rem; color:#d00;">â€»å¤‰æ›´ã—ãŸå†…å®¹ã¯å¿…ãšã€Œä¿å­˜ã€ã—ã¦ã‹ã‚‰å°åˆ·ã—ã¦ãã ã•ã„</div>
      </div>

      <div class="sheet-container">
        <h1 class="sheet-title">ãƒ¬ãƒ³ã‚¿ãƒ«ãƒã‚¤ã‚¯ è²¸æ¸¡è¨¼ å…¼ è»Šä¸¡ç¢ºèªæ›¸</h1>
        <div style="text-align: right; font-size: 9pt;">å—ä»˜No.ï¼š<span id="sheet-id" style="font-weight:bold;"></span></div>

        <input type="hidden" id="sheet-rowIndex">

        <div class="sheet-section">1. å¥‘ç´„åŸºæœ¬æƒ…å ±</div>
        <div class="sheet-box">
          <div class="sheet-row">
            <div class="sheet-col">
              <span class="sheet-label">è»Šç¨®å</span>
              <input type="text" class="sheet-input" id="sheet-bike">
            </div>
            <div class="sheet-col">
              <span class="sheet-label">æœŸé–“</span>
              <input type="text" class="sheet-input" id="sheet-dateRange">
            </div>
          </div>
          <div class="sheet-row">
            <div class="sheet-col">
              <span class="sheet-label">å‡ºç™ºæ™‚ è·é›¢ (km)</span>
              <input type="number" class="sheet-input" id="sheet-startKm" placeholder="å‡ºç™ºæ™‚ã«è¨˜å…¥">
            </div>
            <div class="sheet-col">
              <span class="sheet-label">è¿”å´æ™‚ è·é›¢ (km)</span>
              <input type="number" class="sheet-input" id="sheet-endKm" placeholder="è¿”å´æ™‚ã«è¨˜å…¥">
            </div>
            <div class="sheet-col">
              <span class="sheet-label">è²¸æ¸¡æ–™é‡‘ (ç¨è¾¼)</span>
              <input type="text" class="sheet-input" id="sheet-price">
            </div>
          </div>
        </div>
        
        <div class="sheet-section">2. ã”åˆ©ç”¨è€…æ§˜æƒ…å ±</div>
        <div class="sheet-box">
          <div class="sheet-row">
            <div class="sheet-col" style="flex:2;">
              <span class="sheet-label">æ°å</span>
              <input type="text" class="sheet-input" id="sheet-name">
            </div>
            <div class="sheet-col" style="flex:1.5;">
              <span class="sheet-label">é›»è©±ç•ªå·</span>
              <input type="text" class="sheet-input" id="sheet-phone">
            </div>
          </div>
          <div class="sheet-row">
            <div class="sheet-col">
              <span class="sheet-label">ä½æ‰€</span>
              <input type="text" class="sheet-input" id="sheet-address">
            </div>
          </div>
          <div class="sheet-row">
            <div class="sheet-col">
              <span class="sheet-label">å…è¨±è¨¼ç•ªå· <span style="color:red; font-size:0.8rem;">(â€»å¿…é ˆ)</span></span>
              <input type="text" class="sheet-input" id="sheet-license" placeholder="ã”æ¥åº—æ™‚ã«ã”è¨˜å…¥ãã ã•ã„">
            </div>
          </div>
        </div>

        <div class="sheet-section" style="background:#0056b3;">3. ä¿é™ºãƒ»è£œå„Ÿãƒ—ãƒ©ãƒ³</div>
        <div class="sheet-box" style="background:#fff5f5; border:2px solid #d00;">
          <div style="font-weight:bold; color:#d00; text-align:center;">â–¡ åŠ å…¥ãƒ—ãƒ©ãƒ³ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</div>
          <div style="margin-top:5px;">
            <label style="margin-right:20px;"><input type="checkbox"> å…è²¬è£œå„Ÿåˆ¶åº¦ (CDW) åŠ å…¥</label>
            <label><input type="checkbox"> æœªåŠ å…¥</label>
          </div>
          <hr style="border-top:1px dashed #d00;">
          <div>
            <label><input type="checkbox"> NOCï¼ˆãƒãƒ³ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ¼ã‚¸ï¼‰è¦å®šã«åŒæ„ã—ã¾ã™</label>
          </div>
        </div>

        <div class="sheet-section">4. è»Šä¸¡çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯</div>
        <div class="sheet-box">
          <div class="sheet-row">
            <div class="sheet-col">
              <span class="sheet-label">ç‡ƒæ–™æ®‹é‡</span>
              <input type="text" class="sheet-input" value="å‡ºç™ºï¼š æº€ã‚¿ãƒ³ / è¿”å´ï¼šï¼¿ï¼¿ï¼¿ï¼¿">
            </div>
            <div class="sheet-col">
              <span class="sheet-label">å‚·ãƒã‚§ãƒƒã‚¯ (ãƒ¡ãƒ¢)</span>
              <input type="text" class="sheet-input" placeholder="ä¾‹ï¼šã‚¿ãƒ³ã‚¯å³å´ã«å°å‚·ã‚ã‚Š">
            </div>
          </div>
        </div>

        <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:20px;">
          <div style="font-weight:bold;">ä¸Šè¨˜å†…å®¹ã‚’ç¢ºèªã—ã€ç›¸é•ãªã„ã“ã¨ã‚’èªã‚ã¾ã™ã€‚</div>
          <div style="text-align:right; margin-top:30px;">
            ã”ç½²åï¼š__________________________________________
          </div>
        </div>

      </div>
    </div>

  </div>

  <script>
    // â˜…â˜…â˜… GAS URL â˜…â˜…â˜…
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxWvKydNXGLMLBDXLkigRBnJJeJgRLttFlruTFbDLCFNaKagLONSf_9JOT9hXjFaup_9w/exec";
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

    let currentBookings = [];

    // ç”»é¢åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      fetchBookings();
      var calendarEl = document.getElementById('calendar-el');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next', right: 'dayGridMonth,listWeek' }
      });
      calendar.render();
    });

    function switchView(viewId) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
    }

    // äºˆç´„ãƒªã‚¹ãƒˆå–å¾—
    function fetchBookings() {
      document.getElementById('loading-msg').style.display = 'block';
      fetch(GAS_URL, {
        method: 'POST', headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: "get_bookings" })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('loading-msg').style.display = 'none';
        if(data.result === 'success') {
          currentBookings = data.data;
          renderList(currentBookings);
        }
      });
    }

    function renderList(list) {
      const tbody = document.getElementById('booking-list-body');
      let html = "";
      list.forEach(b => {
        html += `
          <tr>
            <td>${b.date}</td><td>${b.name}</td><td>${b.bike}</td><td>${b.dateRange}</td>
            <td><button class="btn btn-sm" onclick="openSheet('${b.id}')">ğŸ“ è²¸æ¸¡è¨¼ä½œæˆ</button></td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    }

    // â˜…è²¸æ¸¡è¨¼ç”»é¢ã‚’é–‹ã
    function openSheet(bookingId) {
      const booking = currentBookings.find(b => b.id === bookingId);
      if(!booking) return;

      // ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ
      document.getElementById('sheet-id').innerText = booking.id;
      document.getElementById('sheet-rowIndex').value = booking.rowIndex;
      document.getElementById('sheet-bike').value = booking.bike;
      document.getElementById('sheet-dateRange').value = booking.dateRange;
      document.getElementById('sheet-price').value = booking.price;
      
      document.getElementById('sheet-name').value = booking.name;
      document.getElementById('sheet-phone').value = booking.phone;
      document.getElementById('sheet-address').value = booking.address;
      
      // æœªç™»éŒ²ãªã‚‰ç©ºæ¬„ã€ã‚ã‚Œã°è¡¨ç¤º
      document.getElementById('sheet-license').value = booking.license || "";
      document.getElementById('sheet-startKm').value = booking.startKm || "";
      document.getElementById('sheet-endKm').value = booking.endKm || "";

      // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
      switchView('sheet-view');
      document.getElementById('nav-sheet').style.display = 'block';
      document.getElementById('nav-sheet').classList.add('active');
      window.scrollTo(0, 0);
    }

    // â˜…ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹
    function saveSheetData() {
      const btn = document.getElementById('btn-save');
      btn.innerText = "é€šä¿¡ä¸­...";
      btn.disabled = true;

      const newData = {
        action: "update_booking",
        rowIndex: document.getElementById('sheet-rowIndex').value,
        name: document.getElementById('sheet-name').value,
        phone: document.getElementById('sheet-phone').value,
        address: document.getElementById('sheet-address').value,
        license: document.getElementById('sheet-license').value,
        startKm: document.getElementById('sheet-startKm').value,
        endKm: document.getElementById('sheet-endKm').value
      };

      fetch(GAS_URL, {
        method: 'POST', headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(newData)
      })
      .then(res => res.json())
      .then(data => {
        btn.innerText = "ğŸ’¾ ä¿å­˜ã™ã‚‹";
        btn.disabled = false;
        if(data.result === 'success') {
          alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã—ãªãã¦ã‚‚æ¸ˆã‚€ã‚ˆã†ã«ï¼‰
          const idx = currentBookings.findIndex(b => b.rowIndex == newData.rowIndex);
          if(idx !== -1) {
            currentBookings[idx] = { ...currentBookings[idx], ...newData };
          }
        } else {
          alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + data.message);
        }
      });
    }
  </script>
</body>
</html>
