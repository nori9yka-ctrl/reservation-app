// â˜…1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å…¥ã‚Œã¦ãã ã•ã„
const SHEET_ID = '1oZSBfH8GRYP48a-Cmj7P9EusiEjgOENSVLX9bteEEXc'; 

// â˜…2. ã•ã£ãã‚³ãƒ”ãƒ¼ã—ãŸã€Œãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚’ã“ã“ã«å…¥ã‚Œã¦ãã ã•ã„
const CHANNEL_ACCESS_TOKEN = 'NrGIU6c/IQEjviccORRQAchNamOsWKBsQA4C0xBPBvRPFgVG09Jr9JQsQRhj0DjgkhLkrq49P/JYctXiFERnF+Nx8mA7KuuuNzy4fMuig0QUpG3JXIepwSdPIDT0Zyj1rg2HaPAhB6l3AyAqmb/CmwdB04t89/1O/w1cDnyilFU='; 

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    
    // ãƒ‡ãƒ¼ã‚¿å—ã‘å–ã‚Š
    const lineUserId = params.userId;
    const lineDisplayName = params.displayName;
    const regName = params.regName;
    const regKana = params.regKana;
    const regPhone = params.regPhone;
    const regAddress = params.regAddress;
    const dateRange = params.dateRange;
    const totalDays = params.totalDays;
    const bikeName = params.bikeName;
    const options = params.options;
    const memo = params.memo;
    const totalPrice = params.totalPrice;
    const agreement = "åŒæ„æ¸ˆã¿"; 

    // 1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheets()[0];
    sheet.appendRow([
      new Date(),
      lineUserId,
      lineDisplayName,
      regName,
      regKana,
      regPhone,
      regAddress,
      dateRange,
      totalDays,
      bikeName,
      options,
      totalPrice,
      memo,
      agreement
    ]);

    // 2. ãŠå®¢æ§˜ã¸ã®è¿”ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    const userMessage = `
${regName} æ§˜
ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
ä»¥ä¸‹ã®å†…å®¹ã§æ‰¿ã‚Šã¾ã—ãŸã€‚

ğŸ“… æœŸé–“: ${dateRange} (${totalDays})
ğŸ è»Šç¨®: ${bikeName}
â›‘ ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
${options}

ğŸ’° ãŠæ”¯æ‰•äºˆå®šé¡: ${totalPrice}

å½“æ—¥ãŠä¼šã„ã§ãã‚‹ã®ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ï¼
ã”ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ã€ã“ã®LINEã«è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚
`.trim();

    // 3. LINEã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
    sendLineMessage(lineUserId, userMessage);
    
    return ContentService.createTextOutput(JSON.stringify({ result: 'success' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚ãƒ­ã‚°ã«æ®‹ã—ã¦ã€ã‚¹ãƒãƒ›å´ã«ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã•ãªã„ã‚ˆã†ã«ã™ã‚‹
    console.error("Error:", error);
    return ContentService.createTextOutput(JSON.stringify({ result: 'error', message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// LINEã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ãŸã‚ã®ä¾¿åˆ©é–¢æ•°
function sendLineMessage(userId, text) {
  const url = 'https://api.line.me/v2/bot/message/push';
  const options = {
    'method': 'post',
    'headers': {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN
    },
    'payload': JSON.stringify({
      'to': userId,
      'messages': [{
        'type': 'text',
        'text': text
      }]
    })
  };
  
  // é€ä¿¡å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚ç„¡è¦–ã—ã¦é€²ã‚€ã‚ˆã†ã«try-catchï¼‰
  try {
    UrlFetchApp.fetch(url, options);
  } catch (e) {
    console.error("LINEé€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
  }
}
