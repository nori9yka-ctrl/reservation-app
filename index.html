<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¬ãƒ³ã‚¿ãƒ«äºˆç´„</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/ja.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* CSSã‚¹ã‚¿ã‚¤ãƒ« */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f4f8; padding: 20px; color: #333; padding-bottom: 120px; }
    .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 400px; margin: 0 auto; }
    h2 { text-align: center; font-size: 1.3rem; margin-bottom: 20px; color: #06C755; font-weight: bold; }
    .section-title { margin-top: 30px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #eee; font-size: 1.1rem; font-weight: bold; color: #333; }
    
    label { display: block; font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; color: #555; margin-top: 15px; }
    .required::after { content: "å¿…é ˆ"; background: #ff4b4b; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
    .optional::after { content: "ä»»æ„"; background: #aaa; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
    
    input:not([type="checkbox"]), select, textarea { 
      width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; 
      box-sizing: border-box; transition: 0.3s; -webkit-appearance: none; background: #fff; 
    }
    input:focus, select:focus, textarea:focus { border-color: #06C755; outline: none; background-color: #fafffb; }
    
    /* å£²ã‚Šåˆ‡ã‚Œæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    option:disabled { color: #ccc; background-color: #f9f9f9; }

    .zip-group { display: flex; gap: 10px; }
    .zip-group input { width: 120px; } 
    .zip-group button { width: auto; margin: 0; padding: 0 15px; font-size: 0.9rem; background: #666; color: white; border-radius: 10px; border:none; cursor:pointer;}
    
    input.calendar-input { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%2306C755" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>'); background-repeat: no-repeat; background-position: right 10px center; background-size: 20px; cursor: pointer; }
    
    .option-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .option-label { font-size: 0.95rem; flex: 1; }
    .option-price { font-size: 0.85rem; color: #888; margin-right: 10px; }
    .option-select { width: 80px; padding: 8px; margin-bottom: 0; }
    .register-alert { background-color: #e6f9ed; border: 1px solid #06C755; color: #048c3b; padding: 15px; border-radius: 10px; font-size: 0.9rem; margin-bottom: 20px; }
    textarea { resize: vertical; height: 80px; }
    
    .confirm-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .confirm-table th { text-align: left; padding: 10px; border-bottom: 1px solid #eee; color: #888; font-size: 0.85rem; width: 35%; }
    .confirm-table td { text-align: right; padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1rem; }
    .confirm-total { text-align: center; margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 10px; }
    .confirm-total-label { font-size: 0.9rem; color: #555; margin-bottom: 5px; }
    .confirm-total-price { font-size: 2rem; color: #06C755; font-weight: bold; }
    
    .agreement-area { background-color: #fff8f0; border: 1px solid #e0c0a0; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 0.9rem; }
    .agree-item { margin-bottom: 12px; display: flex; align-items: start; cursor: pointer; }
    .agree-item input { width: 20px; height: 20px; margin-right: 10px; margin-top: 2px; -webkit-appearance: checkbox; appearance: checkbox; padding: 0; }
    
    .tos-link { color: #0066cc; text-decoration: underline; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    .btn-back { width: 40%; background: #ccc; color: white; border: none; padding: 15px; border-radius: 30px; font-weight: bold; cursor: pointer; }
    .btn-submit { width: 60%; background: #ccc; color: white; border: none; padding: 15px; border-radius: 30px; font-weight: bold; cursor: not-allowed; transition: 0.3s; }
    .btn-submit.active { background: linear-gradient(135deg, #06C755, #04b34b); box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3); cursor: pointer; }
    
    #input-screen { display: none; }
    #confirm-screen { display: none; }
    #loading { text-align: center; margin-top: 100px; font-weight: bold; color: #666; }
    .price-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display:none; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 100; }
    .total-price { font-size: 1.4rem; font-weight: bold; color: #06C755; }
    .submit-btn-mini { background: #06C755; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 1rem; cursor: pointer; }
    
    .time-container { display: flex; gap: 10px; }
    .time-group { flex: 1; }
    .time-note { font-size: 0.75rem; color: #d00; margin-top: 4px; }
  </style>
</head>
<body>

  <div id="loading">ğŸš€ èª­ã¿è¾¼ã¿ä¸­...</div>

  <div id="input-screen">
    <div class="card">
      <div style="text-align:center; margin-bottom:10px;">
        ã‚ˆã†ã“ã <span id="user-name" style="font-weight:bold;">ã‚²ã‚¹ãƒˆ</span> ã•ã‚“
      </div>
      <h2>ãƒ¬ãƒ³ã‚¿ãƒ«äºˆç´„</h2>

      <div id="register-area">
        <div class="register-alert" id="new-user-msg">ğŸ”° åˆå›ã®ã¿ãŠå®¢æ§˜æƒ…å ±ã‚’ã”ç™»éŒ²ãã ã•ã„</div>
        <div class="register-alert" id="repeat-user-msg" style="display:none; background:#e6f9ed; color:#048c3b;">âœ¨ ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼<br>å‰å›ã®ã”ç™»éŒ²æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</div>
        
        <label class="required">ãŠåå‰</label>
        <input type="text" id="regName" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ">
        <label class="required">ãµã‚ŠãŒãª</label>
        <input type="text" id="regKana" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">
        <label class="required">é›»è©±ç•ªå·</label>
        <input type="tel" id="regPhone" placeholder="090-1234-5678">
        
        <label class="optional">éƒµä¾¿ç•ªå· (ä½æ‰€æ¤œç´¢ç”¨)</label>
        <div class="zip-group">
          <input type="tel" id="zipcode" placeholder="7æ¡ã®æ•°å­—" maxlength="7">
          <button type="button" onclick="searchAddress()">ä½æ‰€æ¤œç´¢</button>
        </div>
        <label class="required">ä½æ‰€</label>
        <input type="text" id="regAddress" placeholder="å¸‚åŒºç”ºæ‘ãƒ»ç•ªåœ°ãƒ»å»ºç‰©å">
      </div>

      <div class="section-title">ã”äºˆç´„å†…å®¹</div>
      <label class="required">ã”åˆ©ç”¨æœŸé–“</label>
      <input type="text" id="dateRange" class="calendar-input" placeholder="æœŸé–“ã‚’é¸æŠ" readonly>
      <div id="days-display" style="text-align:right; font-size:0.8rem; color:#888; margin-top:4px;">0æ³Š0æ—¥</div>

      <div class="time-container">
        <div class="time-group">
          <label class="required">è²¸æ¸¡æ™‚é–“</label>
          <select id="startTime" onchange="checkAvailability()">
            </select>
        </div>
        <div class="time-group">
          <label class="required">è¿”å´æ™‚é–“</label>
          <select id="endTime" onchange="checkAvailability()">
            </select>
        </div>
      </div>
      <div class="time-note">â€»18:00ä»¥é™ã®è¿”å´ã¯ç„¡äººè¿”å´BOXã®ã”åˆ©ç”¨ã¨ãªã‚Šã¾ã™ã€‚</div>

      <label class="required">æ’æ°—é‡ã‚¯ãƒ©ã‚¹</label>
      <select id="classSelect" onchange="updateBikeList()">
        <option value="">ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
      </select>

      <label class="required">è»Šç¨®é¸æŠ</label>
      <div id="bike-loading" style="display:none; color:#06C755; font-size:0.8rem; text-align:right;">ğŸ” ç©ºãçŠ¶æ³ã‚’ç¢ºèªä¸­...</div>
      <select id="bikeSelect" onchange="calcTotal()" disabled>
        <option value="0">å…ˆã«ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
      </select>

      <label>ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠ (1æ—¥ã‚ãŸã‚Š)</label>
      <div id="optionArea"></div>

      <label>å‚™è€ƒ</label>
      <textarea id="memo"></textarea>
      <div style="height: 60px;"></div>
    </div>
  </div>

  <div id="confirm-screen">
    <div class="card">
      <h2>ã”äºˆç´„å†…å®¹ã®ç¢ºèª</h2>
      <p style="text-align:center; font-size:0.9rem; color:#666;">å†…å®¹ã‚’ã”ç¢ºèªã®ä¸Šã€ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚</p>
      <div class="section-title">ãŠå®¢æ§˜æƒ…å ±</div>
      <table class="confirm-table">
        <tr><th>ãŠåå‰</th><td id="conf-name"></td></tr>
        <tr><th>ãµã‚ŠãŒãª</th><td id="conf-kana"></td></tr>
        <tr><th>é›»è©±ç•ªå·</th><td id="conf-phone"></td></tr>
        <tr><th>éƒµä¾¿ç•ªå·</th><td id="conf-zip"></td></tr>
        <tr><th>ä½æ‰€</th><td id="conf-address" style="font-size:0.8rem;"></td></tr>
      </table>
      <div class="section-title">äºˆç´„å†…å®¹</div>
      <table class="confirm-table">
        <tr><th>æœŸé–“</th><td id="conf-date" style="font-size:0.9rem;"></td></tr>
        <tr><th>æ™‚é–“</th><td id="conf-time"></td></tr>
        <tr><th>æ—¥æ•°</th><td id="conf-days"></td></tr>
        <tr><th>ã‚¯ãƒ©ã‚¹</th><td id="conf-class"></td></tr>
        <tr><th>ãƒã‚¤ã‚¯</th><td id="conf-bike" style="font-size:0.9rem;"></td></tr>
        <tr><th>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</th><td id="conf-options" style="font-size:0.8rem; white-space: pre-wrap;"></td></tr>
        <tr><th>å‚™è€ƒ</th><td id="conf-memo" style="font-size:0.8rem;"></td></tr>
      </table>
      <div class="confirm-total">
        <div class="confirm-total-label">ãŠæ”¯æ‰•ã„äºˆå®šç·é¡</div>
        <div class="confirm-total-price" id="conf-price">Â¥0</div>
      </div>
      <div class="agreement-area">
        <div style="font-weight:bold; margin-bottom:10px; text-align:center;">âš ï¸ é‡è¦äº‹é …ã®ç¢ºèª</div>
        <label class="agree-item"><input type="checkbox" id="checkTerms" onchange="checkAgreements()"><span>åˆ©ç”¨è¦ç´„ã®å†…å®¹ã‚’ç¢ºèªã—ã€åŒæ„ã—ã¾ã™ã€‚</span></label>
        <label class="agree-item"><input type="checkbox" id="checkAge" onchange="checkAgreements()"><span>ç§ã¯18æ­³ä»¥ä¸Šã€ã¾ãŸã¯è¦ªæ¨©è€…ã®åŒæ„ã‚’å¾—ãŸæœªæˆå¹´è€…ã§ã‚ã‚‹ã“ã¨ã‚’èª“ç´„ã—ã¾ã™ã€‚</span></label>
      </div>
      <div class="btn-group">
        <button class="btn-back" onclick="goBack()">ä¿®æ­£ã™ã‚‹</button>
        <button class="btn-submit" id="finalSubmitBtn" onclick="sendToGas()" disabled>äºˆç´„ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div class="price-bar" id="price-bar">
    <div>
      <div style="font-size:0.8rem; color:#555;">ãŠæ”¯æ‰•ã„äºˆå®šé¡</div>
      <div class="total-price" id="totalPriceDisplay">Â¥0</div>
    </div>
    <button class="submit-btn-mini" onclick="showConfirm()">ç¢ºèªã¸é€²ã‚€</button>
  </div>

  <script>
    // â˜…â˜…â˜… GAS URL â˜…â˜…â˜…
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxWvKydNXGLMLBDXLkigRBnJJeJgRLttFlruTFbDLCFNaKagLONSf_9JOT9hXjFaup_9w/exec";
    const MY_LIFF_ID = "2008826232-lvGwqtl1";
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

    const masterData = {
      categories: [
        {
          name: "åŸä»˜ã‚¹ã‚¯ãƒ¼ã‚¿ãƒ¼ (50cc)",
          bikes: [
            { name: "ã‚¸ãƒ§ã‚° (é»’)", price: 3000 },
            { name: "ãƒ“ãƒ¼ãƒ (ç™½)", price: 3000 },
            { name: "ãƒ¬ãƒƒãƒ„4 (éŠ€)", price: 2800 }
          ]
        },
        {
          name: "ä¸­å‹ãƒã‚¤ã‚¯ (400cc)",
          bikes: [
            { name: "CB400SF (èµ¤ç™½)", price: 8000 },
            { name: "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ã‚¿ãƒ¼400", price: 8500 },
            { name: "Ninja 400 (ç·‘)", price: 9000 }
          ]
        },
        {
          name: "å¤§å‹ãƒã‚¤ã‚¯ (Over 750cc)",
          bikes: [
            { name: "ãƒãƒ¼ãƒ¬ãƒ¼ãƒ€ãƒ“ãƒƒãƒ‰ã‚½ãƒ³", price: 15000 },
            { name: "CB1300SF", price: 14000 }
          ]
        }
      ],
      options: [
        { name: "ãƒ˜ãƒ«ãƒ¡ãƒƒãƒˆ", price: 500 },
        { name: "ã‚°ãƒ­ãƒ¼ãƒ–", price: 300 },
        { name: "è»Šä¸¡è£œå„Ÿ", price: 1000 }
      ]
    };

    let fpInstance;
    let lineProfile = null;
    let busyBikesCache = []; 

    window.onload = function() {
      liff.init({ liffId: MY_LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            liff.getProfile().then(profile => {
              lineProfile = profile;
              document.getElementById('user-name').innerText = profile.displayName;
              checkUserStatus(profile.userId);
            });
          }
        })
        .catch(err => {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('input-screen').style.display = 'block';
          document.getElementById('price-bar').style.display = 'flex';
        });

      fpInstance = flatpickr("#dateRange", {
        mode: "range", minDate: "today", dateFormat: "Y-m-d", locale: "ja", disableMobile: "true",
        onClose: function() { 
          calcTotal();
          checkAvailability(); 
        }
      });

      generateTimeOptions('startTime', 9, 18);
      generateTimeOptions('endTime', 0, 23);

      const classSelect = document.getElementById('classSelect');
      masterData.categories.forEach((cat, index) => {
        const option = document.createElement('option');
        option.value = index; 
        option.textContent = cat.name;
        classSelect.appendChild(option);
      });

      const optionArea = document.getElementById('optionArea');
      masterData.options.forEach((opt) => {
        const div = document.createElement('div');
        div.className = 'option-row';
        div.innerHTML = `
          <div class="option-label">${opt.name}</div>
          <div class="option-price">+Â¥${opt.price}</div>
          <select class="option-select" data-price="${opt.price}" data-name="${opt.name}" onchange="calcTotal()">
            <option value="0">ãªã—</option>
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        `;
        optionArea.appendChild(div);
      });
    };

    function generateTimeOptions(elementId, startHour, endHour) {
      const select = document.getElementById(elementId);
      for(let i=startHour; i<=endHour; i++) {
        const option = document.createElement('option');
        const timeStr = i + ":00";
        option.value = timeStr;
        option.text = timeStr;
        if(elementId === 'startTime' && i === 10) option.selected = true;
        if(elementId === 'endTime' && i === 18) option.selected = true;
        select.appendChild(option);
      }
    }

    // â˜…æ—¥ä»˜æ•´å½¢ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function formatDateYMD(date) {
      const y = date.getFullYear();
      const m = date.getMonth() + 1;
      const d = date.getDate();
      return `${y}/${m}/${d}`;
    }

    // â˜…åœ¨åº«ãƒã‚§ãƒƒã‚¯ï¼ˆä¿®æ­£ç‰ˆï¼‰
    function checkAvailability() {
      // ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ãªãã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥ä½¿ã†
      const dates = fpInstance.selectedDates;
      if (dates.length === 0) return;

      let startYMD = formatDateYMD(dates[0]);
      let endYMD = dates.length > 1 ? formatDateYMD(dates[1]) : startYMD;

      const sTime = document.getElementById('startTime').value;
      const eTime = document.getElementById('endTime').value;
      
      const fullStart = `${startYMD} ${sTime}`;
      const fullEnd = `${endYMD} ${eTime}`;

      document.getElementById('bike-loading').style.display = 'block';

      fetch(GAS_URL, {
        method: 'POST', headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: "check_availability", startDate: fullStart, endDate: fullEnd })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('bike-loading').style.display = 'none';
        if (data.result === 'success') {
          busyBikesCache = data.busyBikes;
          updateBikeList();
        }
      });
    }

    function updateBikeList() {
      const classIdx = document.getElementById('classSelect').value;
      const bikeSelect = document.getElementById('bikeSelect');
      
      bikeSelect.innerHTML = '<option value="0">é¸æŠã—ã¦ãã ã•ã„</option>';
      
      if (classIdx === "") {
        bikeSelect.disabled = true;
        calcTotal();
        return;
      }

      const bikes = masterData.categories[classIdx].bikes;
      bikes.forEach(bike => {
        const option = document.createElement('option');
        option.value = bike.name;
        option.dataset.price = bike.price;

        if (busyBikesCache.includes(bike.name)) {
          option.disabled = true;
          option.textContent = `âŒ ${bike.name} (è²¸å‡ºä¸­)`;
        } else {
          option.textContent = `${bike.name} (Â¥${bike.price.toLocaleString()}/æ—¥)`;
        }
        
        bikeSelect.appendChild(option);
      });
      
      bikeSelect.disabled = false;
      calcTotal();
    }

    // â˜…äºˆç´„é€ä¿¡ï¼ˆä¿®æ­£ç‰ˆï¼‰
    function sendToGas() {
      const btn = document.getElementById('finalSubmitBtn');
      btn.disabled = true;
      btn.innerText = "é€ä¿¡ä¸­...";

      // ã“ã“ã§ã‚‚Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã†
      const dates = fpInstance.selectedDates;
      let startYMD = formatDateYMD(dates[0]);
      let endYMD = dates.length > 1 ? formatDateYMD(dates[1]) : startYMD;

      const sTime = document.getElementById('startTime').value;
      const eTime = document.getElementById('endTime').value;
      
      const fullDateRange = `${startYMD} ${sTime} ã€œ ${endYMD} ${eTime}`;

      const postData = {
        action: "reserve",
        userId: lineProfile ? lineProfile.userId : "unknown",
        displayName: lineProfile ? lineProfile.displayName : "unknown",
        regName: document.getElementById('conf-name').innerText,
        regKana: document.getElementById('conf-kana').innerText,
        regPhone: document.getElementById('conf-phone').innerText,
        regZip: document.getElementById('conf-zip').innerText, 
        regAddress: document.getElementById('conf-address').innerText,
        dateRange: fullDateRange,
        totalDays: document.getElementById('conf-days').innerText,
        bikeName: document.getElementById('conf-bike').innerText,
        options: document.getElementById('conf-options').innerText,
        memo: document.getElementById('conf-memo').innerText,
        totalPrice: document.getElementById('conf-price').innerText
      };

      fetch(GAS_URL, {
        method: 'POST', headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(postData)
      }).then(() => {
        alert("ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\näºˆç´„å®Œäº†ã—ã¾ã—ãŸã€‚");
        liff.closeWindow(); 
      }).catch(err => {
        console.error(err);
        alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err);
        btn.disabled = false;
        btn.innerText = "äºˆç´„ç¢ºå®š";
      });
    }

    // --- ãã®ä»–å…±é€šé–¢æ•° ---
    function checkUserStatus(userId) {
      document.getElementById('loading').innerHTML = "ğŸ”„ ãŠå®¢æ§˜æƒ…å ±ã‚’ç¢ºèªä¸­...";
      const postData = { action: "check", userId: userId };
      fetch(GAS_URL, { method: 'POST', body: JSON.stringify(postData) })
      .then(res => res.json())
      .then(data => {
        if (data.result === 'found') {
          const u = data.userData;
          document.getElementById('regName').value = u.regName;
          document.getElementById('regKana').value = u.regKana;
          document.getElementById('regPhone').value = u.regPhone;
          document.getElementById('zipcode').value = u.regZip || ""; 
          document.getElementById('regAddress').value = u.regAddress;
          document.getElementById('new-user-msg').style.display = 'none';
          document.getElementById('repeat-user-msg').style.display = 'block';
        }
        document.getElementById('loading').style.display = 'none';
        document.getElementById('input-screen').style.display = 'block';
        document.getElementById('price-bar').style.display = 'flex';
      });
    }

    function searchAddress() {
      const zip = document.getElementById('zipcode').value;
      if (zip.length < 7) return alert("éƒµä¾¿ç•ªå·ã¯7æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
      fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${zip}`)
        .then(res => res.json())
        .then(data => {
          if (data.results) {
            document.getElementById('regAddress').value = data.results[0].address1 + data.results[0].address2 + data.results[0].address3;
          } else { alert("ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"); }
        });
    }

    function calcTotal() {
      const dates = fpInstance.selectedDates;
      if(dates.length === 0) return;
      let days = 0;
      if (dates.length === 1) days = 1;
      else if (dates.length === 2) days = Math.ceil(Math.abs(dates[1] - dates[0]) / (86400000)) + 1;
      document.getElementById('days-display').innerText = days > 0 ? `${days-1}æ³Š ${days}æ—¥` : "0æ³Š0æ—¥";

      const bikeSel = document.getElementById('bikeSelect');
      const bikePrice = bikeSel.options[bikeSel.selectedIndex].dataset.price || 0;

      let optionTotal = 0;
      document.querySelectorAll('.option-select').forEach(sel => {
        optionTotal += parseInt(sel.dataset.price) * parseInt(sel.value);
      });

      const total = (parseInt(bikePrice) + optionTotal) * days;
      document.getElementById('totalPriceDisplay').innerText = "Â¥" + total.toLocaleString();
      return total;
    }

    function showConfirm() {
      const regName = document.getElementById('regName').value;
      const regKana = document.getElementById('regKana').value;
      const regPhone = document.getElementById('regPhone').value;
      const regZip = document.getElementById('zipcode').value; 
      const regAddress = document.getElementById('regAddress').value;
      if(!regName || !regKana || !regPhone || !regAddress) { alert("âš ï¸ ãŠå®¢æ§˜æƒ…å ±ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      const dates = fpInstance.selectedDates;
      if(dates.length === 0) { alert("âš ï¸ æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const bikeSel = document.getElementById('bikeSelect');
      if(bikeSel.value === "0") { alert("âš ï¸ ãƒã‚¤ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const sTime = document.getElementById('startTime').value;
      const eTime = document.getElementById('endTime').value;
      
      let startYMD = formatDateYMD(dates[0]);
      let endYMD = dates.length > 1 ? formatDateYMD(dates[1]) : startYMD;

      document.getElementById('conf-name').innerText = regName;
      document.getElementById('conf-kana').innerText = regKana;
      document.getElementById('conf-phone').innerText = regPhone;
      document.getElementById('conf-zip').innerText = regZip; 
      document.getElementById('conf-address').innerText = regAddress;
      document.getElementById('conf-date').innerText = `${startYMD} ã€œ ${endYMD}`;
      document.getElementById('conf-time').innerText = `${sTime} ã€œ ${eTime}`;
      document.getElementById('conf-days').innerText = document.getElementById('days-display').innerText;
      
      const classSel = document.getElementById('classSelect');
      document.getElementById('conf-class').innerText = classSel.options[classSel.selectedIndex].text;
      document.getElementById('conf-bike').innerText = bikeSel.value;
      document.getElementById('conf-memo').innerText = document.getElementById('memo').value || "ãªã—";
      
      let optStr = "";
      document.querySelectorAll('.option-select').forEach(sel => {
        if(parseInt(sel.value) > 0) optStr += `${sel.dataset.name} Ã— ${sel.value}\n`;
      });
      document.getElementById('conf-options').innerText = optStr || "ãªã—";
      document.getElementById('conf-price').innerText = document.getElementById('totalPriceDisplay').innerText;

      document.getElementById('input-screen').style.display = 'none';
      document.getElementById('price-bar').style.display = 'none';
      document.getElementById('confirm-screen').style.display = 'block';
      window.scrollTo(0, 0);
      document.getElementById('checkTerms').checked = false;
      document.getElementById('checkAge').checked = false;
      checkAgreements();
    }

    function goBack() {
      document.getElementById('confirm-screen').style.display = 'none';
      document.getElementById('input-screen').style.display = 'block';
      document.getElementById('price-bar').style.display = 'flex';
    }

    function checkAgreements() {
      const isTermsChecked = document.getElementById('checkTerms').checked;
      const isAgeChecked = document.getElementById('checkAge').checked;
      const btn = document.getElementById('finalSubmitBtn');
      if (isTermsChecked && isAgeChecked) {
        btn.disabled = false;
        btn.classList.add('active');
      } else {
        btn.disabled = true;
        btn.classList.remove('active');
      }
    }
  </script>
</body>
</html>
