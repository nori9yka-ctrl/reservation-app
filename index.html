<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¬ãƒ³ã‚¿ãƒ«äºˆç´„</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/ja.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* CSSã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¤‰æ›´ãªã—ï¼‰ */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f4f8; padding: 20px; color: #333; padding-bottom: 120px; }
    .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 400px; margin: 0 auto; }
    h2 { text-align: center; font-size: 1.3rem; margin-bottom: 20px; color: #06C755; font-weight: bold; }
    .section-title { margin-top: 30px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #eee; font-size: 1.1rem; font-weight: bold; color: #333; }
    label { display: block; font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; color: #555; margin-top: 15px; }
    .required::after { content: "å¿…é ˆ"; background: #ff4b4b; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
    .optional::after { content: "ä»»æ„"; background: #aaa; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
    input:not([type="checkbox"]), select, textarea { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; box-sizing: border-box; transition: 0.3s; -webkit-appearance: none; background: #fff; }
    input:focus, select:focus, textarea:focus { border-color: #06C755; outline: none; background-color: #fafffb; }
    option:disabled { color: #ccc; background-color: #f9f9f9; }
    .zip-group { display: flex; gap: 10px; } .zip-group input { width: 120px; } .zip-group button { width: auto; margin: 0; padding: 0 15px; font-size: 0.9rem; background: #666; color: white; border-radius: 10px; border:none; cursor:pointer;}
    input.calendar-input { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%2306C755" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>'); background-repeat: no-repeat; background-position: right 10px center; background-size: 20px; cursor: pointer; }
    .option-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .option-label { font-size: 0.95rem; flex: 1; }
    .option-price { font-size: 0.85rem; color: #888; margin-right: 10px; }
    .option-select { width: 80px; padding: 8px; margin-bottom: 0; }
    .register-alert { background-color: #e6f9ed; border: 1px solid #06C755; color: #048c3b; padding: 15px; border-radius: 10px; font-size: 0.9rem; margin-bottom: 20px; }
    textarea { resize: vertical; height: 80px; }
    .confirm-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .confirm-table th { text-align: left; padding: 10px; border-bottom: 1px solid #eee; color: #888; font-size: 0.85rem; width: 35%; }
    .confirm-table td { text-align: right; padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; font-size: 1rem; }
    .confirm-total { text-align: center; margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 10px; }
    .confirm-total-label { font-size: 0.9rem; color: #555; margin-bottom: 5px; }
    .confirm-total-price { font-size: 2rem; color: #06C755; font-weight: bold; }
    .agreement-area { background-color: #fff8f0; border: 1px solid #e0c0a0; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 0.9rem; }
    .agree-item { margin-bottom: 12px; display: flex; align-items: start; cursor: pointer; }
    .agree-item input { width: 20px; height: 20px; margin-right: 10px; margin-top: 2px; -webkit-appearance: checkbox; appearance: checkbox; padding: 0; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    .btn-back { width: 40%; background: #ccc; color: white; border: none; padding: 15px; border-radius: 30px; font-weight: bold; cursor: pointer; }
    .btn-submit { width: 60%; background: #ccc; color: white; border: none; padding: 15px; border-radius: 30px; font-weight: bold; cursor: not-allowed; transition: 0.3s; }
    .btn-submit.active { background: linear-gradient(135deg, #06C755, #04b34b); box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3); cursor: pointer; }
    #input-screen { display: none; } #confirm-screen { display: none; }
    #loading { text-align: center; margin-top: 100px; font-weight: bold; color: #666; }
    .price-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display:none; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 100; }
    .total-price { font-size: 1.4rem; font-weight: bold; color: #06C755; }
    .submit-btn-mini { background: #06C755; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 1rem; cursor: pointer; }
    .time-container { display: flex; gap: 10px; } .time-group { flex: 1; } .time-note { font-size: 0.75rem; color: #d00; margin-top: 4px; }
  </style>
</head>
<body>
  <div id="loading">ğŸš€ èª­ã¿è¾¼ã¿ä¸­...</div>
  
  <div id="input-screen">
    <div class="card">
      <div style="text-align:center; margin-bottom:10px;">ã‚ˆã†ã“ã <span id="user-name" style="font-weight:bold;">ã‚²ã‚¹ãƒˆ</span> ã•ã‚“</div>
      <h2>ãƒ¬ãƒ³ã‚¿ãƒ«äºˆç´„</h2>
      
      <div id="register-area">
        <div class="register-alert" id="new-user-msg">ğŸ”° åˆå›ã®ã¿ãŠå®¢æ§˜æƒ…å ±ã‚’ã”ç™»éŒ²ãã ã•ã„</div>
        <div class="register-alert" id="repeat-user-msg" style="display:none; background:#e6f9ed; color:#048c3b;">âœ¨ ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼<br>å‰å›ã®ã”ç™»éŒ²æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</div>
        <label class="required">ãŠåå‰</label><input type="text" id="regName" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ">
        <label class="required">ãµã‚ŠãŒãª</label><input type="text" id="regKana" placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†">
        <label class="required">é›»è©±ç•ªå·</label><input type="tel" id="regPhone" placeholder="090-1234-5678">
        <label class="optional">éƒµä¾¿ç•ªå·</label><div class="zip-group"><input type="tel" id="zipcode" placeholder="7æ¡" maxlength="7"><button type="button" onclick="searchAddress()">æ¤œç´¢</button></div>
        <label class="required">ä½æ‰€</label><input type="text" id="regAddress" placeholder="å¸‚åŒºç”ºæ‘ãƒ»ç•ªåœ°ãƒ»å»ºç‰©å">
      </div>

      <div class="section-title">ã”äºˆç´„å†…å®¹</div>
      <label class="required">ã”åˆ©ç”¨æœŸé–“</label><input type="text" id="dateRange" class="calendar-input" placeholder="æœŸé–“ã‚’é¸æŠ" readonly>
      <div class="time-container">
        <div class="time-group"><label class="required">è²¸æ¸¡æ™‚é–“</label><select id="startTime" onchange="checkAvailability()"></select></div>
        <div class="time-group"><label class="required">è¿”å´æ™‚é–“</label><select id="endTime" onchange="checkAvailability()"></select></div>
      </div>
      <div id="days-display" style="text-align:right; font-size:0.8rem; color:#888; margin-top:4px;">0æ™‚é–“</div>
      <div class="time-note">â€»18:00ä»¥é™ã®è¿”å´ã¯ç„¡äººè¿”å´BOXã®ã”åˆ©ç”¨ã¨ãªã‚Šã¾ã™ã€‚<br>â€»æœ¨æ›œæ—¥ã¯å®šä¼‘æ—¥ã®ãŸã‚è²¸å‡ºï¼ˆå‡ºç™ºï¼‰ã¯ã§ãã¾ã›ã‚“ã€‚</div>

      <label class="required">æ’æ°—é‡ã‚¯ãƒ©ã‚¹</label><select id="classSelect" onchange="updateBikeList()"><option value="">èª­ã¿è¾¼ã¿ä¸­...</option></select>
      <label class="required">è»Šç¨®é¸æŠ</label><select id="bikeSelect" onchange="calcTotal()" disabled><option value="0">å…ˆã«ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
      
      <label>ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠ (1æ—¥ã‚ãŸã‚Š)</label><div id="optionArea"></div>
      <label>å‚™è€ƒ</label><textarea id="memo"></textarea><div style="height: 60px;"></div>
    </div>
  </div>

  <div id="confirm-screen">
    <div class="card">
      <h2>ã”äºˆç´„å†…å®¹ã®ç¢ºèª</h2>
      <div class="section-title">ãŠå®¢æ§˜æƒ…å ±</div>
      <table class="confirm-table"><tr><th>ãŠåå‰</th><td id="conf-name"></td></tr><tr><th>é›»è©±ç•ªå·</th><td id="conf-phone"></td></tr></table>
      <div class="section-title">äºˆç´„å†…å®¹</div>
      <table class="confirm-table">
        <tr><th>æœŸé–“</th><td id="conf-date" style="font-size:0.9rem;"></td></tr>
        <tr><th>æ™‚é–“</th><td id="conf-time"></td></tr>
        <tr><th>åˆ©ç”¨æ™‚é–“</th><td id="conf-hours"></td></tr>
        <tr><th>ãƒã‚¤ã‚¯</th><td id="conf-bike" style="font-size:0.9rem;"></td></tr>
        <tr><th>é©ç”¨ãƒ—ãƒ©ãƒ³</th><td id="conf-plan" style="font-size:0.8rem;"></td></tr>
        <tr><th>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</th><td id="conf-options" style="font-size:0.8rem;"></td></tr>
      </table>
      <div class="confirm-total"><div class="confirm-total-label">ãŠæ”¯æ‰•ã„äºˆå®šç·é¡</div><div class="confirm-total-price" id="conf-price">Â¥0</div></div>
      <div class="agreement-area">
        <div style="font-weight:bold; margin-bottom:10px; text-align:center;">âš ï¸ é‡è¦äº‹é …ã®ç¢ºèª</div>
        <label class="agree-item"><input type="checkbox" id="checkTerms" onchange="checkAgreements()"><span>åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¾ã™ã€‚</span></label>
        <label class="agree-item"><input type="checkbox" id="checkAge" onchange="checkAgreements()"><span>18æ­³ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ã‚’èª“ç´„ã—ã¾ã™ã€‚</span></label>
      </div>
      <div class="btn-group"><button class="btn-back" onclick="goBack()">ä¿®æ­£ã™ã‚‹</button><button class="btn-submit" id="finalSubmitBtn" onclick="sendToGas()" disabled>äºˆç´„ç¢ºå®š</button></div>
    </div>
  </div>
  <div class="price-bar" id="price-bar"><div><div style="font-size:0.8rem; color:#555;">ãŠæ”¯æ‰•ã„äºˆå®šé¡</div><div class="total-price" id="totalPriceDisplay">Â¥0</div></div><button class="submit-btn-mini" onclick="showConfirm()">ç¢ºèªã¸é€²ã‚€</button></div>

  <script>
    // â˜… GAS URL â˜…
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxWvKydNXGLMLBDXLkigRBnJJeJgRLttFlruTFbDLCFNaKagLONSf_9JOT9hXjFaup_9w/exec";
    const MY_LIFF_ID = "2008826232-lvGwqtl1";

    let masterData = { categories: [], options: [] };
    let allReservations = []; // â˜…ä¿®æ­£: å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹å¤‰æ•°
    let fpInstance; let lineProfile = null; 

    window.onload = function() {
      liff.init({ liffId: MY_LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) { liff.login(); } 
        else { liff.getProfile().then(p => { lineProfile = p; document.getElementById('user-name').innerText = p.displayName; checkUserStatus(p.userId); }); }
        
        // â˜…ä¿®æ­£: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã®é †åº
        // 1. ãƒã‚¹ã‚¿å–å¾— -> 2. å…¨äºˆç´„å–å¾—
        fetchMasterData();
      }).catch(e => fetchMasterData());

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®šï¼ˆæœ¨æ›œãƒã‚§ãƒƒã‚¯ï¼‰
      fpInstance = flatpickr("#dateRange", { 
        mode: "range", minDate: "today", dateFormat: "Y-m-d", locale: "ja", disableMobile: "true",
        onClose: function(selectedDates) {
          if(selectedDates.length > 0) {
            if(selectedDates[0].getDay() === 4) {
              alert("æœ¨æ›œæ—¥ã¯å®šä¼‘æ—¥ã®ãŸã‚ã€è²¸å‡ºï¼ˆå‡ºç™ºï¼‰ã«ã¯æŒ‡å®šã§ãã¾ã›ã‚“ã€‚\nï¼ˆè¿”å´ã®ã¿ã®å ´åˆã¯å¯èƒ½ã§ã™ï¼‰");
              fpInstance.clear(); return;
            }
          }
          calcTotal(); 
          checkAvailability(); // â˜…ä¿®æ­£: é€šä¿¡ã›ãšãƒ¡ãƒ¢ãƒªå†…ã§å³æ™‚ãƒã‚§ãƒƒã‚¯
        } 
      });
      generateTimeOptions('startTime', 9, 18); generateTimeOptions('endTime', 0, 23);
    };

    function fetchMasterData() {
      fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "get_master_data" }) }).then(r=>r.json()).then(d=>{
        if (d.result === 'success') { 
          masterData.categories = d.categories; 
          masterData.options = d.options; 
          initClassSelect(); initOptionSelect(); 
          // â˜…ã“ã“ã§å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã«è¡Œã
          fetchAllReservations();
        }
      });
    }

    // â˜…è¿½åŠ : äºˆç´„æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’ä¸€æ‹¬å–å¾—ã—ã¦ãƒ¡ãƒ¢ãƒªã«ä¿å­˜
    function fetchAllReservations() {
      fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "get_reserved_ranges" }) }).then(r=>r.json()).then(d=>{
        if(d.result === 'success') {
          allReservations = d.data; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼
          // ã“ã“ã§åˆã‚ã¦ç”»é¢ã‚’è¡¨ç¤º
          document.getElementById('loading').style.display = 'none'; 
          document.getElementById('input-screen').style.display = 'block'; 
          document.getElementById('price-bar').style.display = 'flex'; 
        }
      });
    }

    // â˜…ä¿®æ­£: ãƒ¡ãƒ¢ãƒªå†…ã§åœ¨åº«ãƒã‚§ãƒƒã‚¯ï¼ˆçˆ†é€Ÿï¼‰
    function checkAvailability() {
      const dates = fpInstance.selectedDates;
      if (dates.length === 0) return;
      
      let sYMD = formatDateYMD(dates[0]);
      let eYMD = dates.length > 1 ? formatDateYMD(dates[1]) : sYMD;
      const fullStart = new Date(`${sYMD} ${document.getElementById('startTime').value}:00`);
      const fullEnd = new Date(`${eYMD} ${document.getElementById('endTime').value}:00`);

      // ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†è¨ˆç®—
      let busyBikes = [];
      
      allReservations.forEach(r => {
        // æ–‡å­—åˆ—ã®æ—¥ä»˜ã‚’Dateå‹ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
        const bookedStart = new Date(r.start);
        const bookedEnd = new Date(r.end);
        
        // é‡è¤‡åˆ¤å®š (å¸Œæœ›é–‹å§‹ < äºˆç´„çµ‚äº† AND å¸Œæœ›çµ‚äº† > äºˆç´„é–‹å§‹)
        if (fullStart < bookedEnd && fullEnd > bookedStart) {
          busyBikes.push(r.bike);
        }
      });

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã¯ãªãã€å¼•æ•°ã§æ¸¡ã™ã‹ç›´æ¥updateBikeListã‚’å‘¼ã¶å½¢ã«å¤‰æ›´
      updateBikeList([...new Set(busyBikes)]); 
    }

    function updateBikeList(busyList = []) { 
      const idx = document.getElementById('classSelect').value; 
      const bs = document.getElementById('bikeSelect'); 
      const currentVal = bs.value; // é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒåŠªåŠ›
      
      bs.innerHTML = '<option value="0">é¸æŠã—ã¦ãã ã•ã„</option>'; 
      if (idx === "") { bs.disabled = true; return; } 
      
      const bikes = masterData.categories[idx].bikes; 
      bikes.forEach(b => { 
        const o = document.createElement('option'); 
        o.value = b.name; 
        o.dataset.p4 = b.p4; o.dataset.p8 = b.p8; o.dataset.p24 = b.p24; o.dataset.pAdd = b.pAdd; 
        
        if (busyList.includes(b.name)) { 
          o.disabled = true; 
          o.textContent = `âŒ ${b.name} (è²¸å‡ºä¸­)`; 
        } else { 
          o.textContent = `${b.name}`; 
        } 
        bs.appendChild(o); 
      }); 
      bs.disabled = false; 
      
      // ã‚‚ã—é¸ã‚“ã§ã„ãŸãƒã‚¤ã‚¯ãŒã¾ã æœ‰åŠ¹ãªã‚‰é¸æŠç¶­æŒ
      if(currentVal && !busyList.includes(currentVal)) {
        bs.value = currentVal;
      }
      calcTotal(); 
    }

    // --- ãã®ä»– (å¤‰æ›´ãªã—) ---
    function initClassSelect() { const s = document.getElementById('classSelect'); s.innerHTML = '<option value="">ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>'; masterData.categories.forEach((c, i) => { const o = document.createElement('option'); o.value = i; o.textContent = c.name; s.appendChild(o); }); }
    function initOptionSelect() { const area = document.getElementById('optionArea'); area.innerHTML = ""; masterData.options.forEach(opt => { const div = document.createElement('div'); div.className = 'option-row'; div.innerHTML = `<div class="option-label">${opt.name}</div><div class="option-price">+Â¥${opt.price}</div><select class="option-select" data-price="${opt.price}" data-name="${opt.name}" onchange="calcTotal()"><option value="0">ãªã—</option><option value="1">1</option><option value="2">2</option></select>`; area.appendChild(div); }); }
    function calcTotal() {
      // å¤‰æ›´æ™‚ã« checkAvailability ã‚‚å‘¼ã‚“ã§ãŠãï¼ˆæ™‚é–“ãŒå¤‰ã‚ã‚‹ã¨åœ¨åº«ã‚‚å¤‰ã‚ã‚‹ãŸã‚ï¼‰
      // ãŸã ã—ç„¡é™ãƒ«ãƒ¼ãƒ—ã—ãªã„ã‚ˆã†ã«æ³¨æ„
      // ã“ã“ã§ã¯è¨ˆç®—ã ã‘è¡Œã†
      const dates = fpInstance.selectedDates;
      if (dates.length === 0) return;
      const sDate = dates[0]; const eDate = dates.length > 1 ? dates[1] : sDate;
      const sH = parseInt(document.getElementById('startTime').value); const eH = parseInt(document.getElementById('endTime').value);
      const start = new Date(sDate); start.setHours(sH); const end = new Date(eDate); end.setHours(eH);
      let diffMs = end - start;
      if (diffMs <= 0) { document.getElementById('days-display').innerText = "ã‚¨ãƒ©ãƒ¼: æ—¥æ™‚ã‚’ç¢ºèªã—ã¦ãã ã•ã„"; document.getElementById('totalPriceDisplay').innerText = "Â¥0"; return; }
      const diffHours = diffMs / (1000 * 60 * 60); const diffDays = Math.ceil(diffHours / 24);
      document.getElementById('days-display').innerText = `åˆ©ç”¨æ™‚é–“: ${diffHours}æ™‚é–“`;
      const bikeSel = document.getElementById('bikeSelect');
      if (bikeSel.value === "0") return;
      const dataset = bikeSel.options[bikeSel.selectedIndex].dataset;
      const p4 = parseInt(dataset.p4); const p8 = parseInt(dataset.p8); const p24 = parseInt(dataset.p24); const pAdd = parseInt(dataset.pAdd);
      let basePrice = 0; let planName = "";
      if (diffHours <= 4) { basePrice = p4; planName = "4æ™‚é–“æ–™é‡‘"; } else if (diffHours <= 8) { basePrice = p8; planName = "8æ™‚é–“æ–™é‡‘"; } else if (diffHours <= 24) { basePrice = p24; planName = "24æ™‚é–“æ–™é‡‘"; } else { const extraDays = Math.ceil((diffHours - 24) / 24); basePrice = p24 + (pAdd * extraDays); planName = `24æ™‚é–“ + è¿½åŠ ${extraDays}æ—¥`; }
      let optionTotal = 0; document.querySelectorAll('.option-select').forEach(sel => { optionTotal += parseInt(sel.dataset.price) * parseInt(sel.value) * diffDays; });
      const total = basePrice + optionTotal;
      document.getElementById('totalPriceDisplay').innerText = "Â¥" + total.toLocaleString();
      document.getElementById('conf-plan').innerText = planName; document.getElementById('conf-hours').innerText = `${diffHours}æ™‚é–“`;
      return total;
    }
    
    function generateTimeOptions(id, s, e) { const sel = document.getElementById(id); for(let i=s; i<=e; i++){ const o=document.createElement('option'); o.value=i; o.text=i+":00"; if(id==='startTime'&&i===10)o.selected=true; if(id==='endTime'&&i===18)o.selected=true; sel.appendChild(o); } }
    function formatDateYMD(d){ return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
    function checkUserStatus(uid){ fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:"check",userId:uid})}).then(r=>r.json()).then(d=>{if(d.result==='found'){const u=d.userData;document.getElementById('regName').value=u.regName;document.getElementById('regKana').value=u.regKana;document.getElementById('regPhone').value=u.regPhone;document.getElementById('zipcode').value=u.regZip;document.getElementById('regAddress').value=u.regAddress;document.getElementById('new-user-msg').style.display='none';document.getElementById('repeat-user-msg').style.display='block';}});}
    function searchAddress(){ const z=document.getElementById('zipcode').value; fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${z}`).then(r=>r.json()).then(d=>{if(d.results)document.getElementById('regAddress').value=d.results[0].address1+d.results[0].address2+d.results[0].address3;else alert("ä½æ‰€ä¸æ˜");}); }
    function showConfirm(){ const name=document.getElementById('regName').value; const phone=document.getElementById('regPhone').value; if(!name||!phone||!document.getElementById('regAddress').value){alert("ãŠå®¢æ§˜æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;} if(document.getElementById('bikeSelect').value==="0"){alert("ãƒã‚¤ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„");return;} document.getElementById('conf-name').innerText=name; document.getElementById('conf-phone').innerText=phone; document.getElementById('conf-date').innerText=document.getElementById('dateRange').value; document.getElementById('conf-time').innerText=`${document.getElementById('startTime').value}:00 ã€œ ${document.getElementById('endTime').value}:00`; document.getElementById('conf-bike').innerText=document.getElementById('bikeSelect').value; document.getElementById('conf-price').innerText=document.getElementById('totalPriceDisplay').innerText; let optStr=""; document.querySelectorAll('.option-select').forEach(s=>{if(s.value>0)optStr+=`${s.dataset.name}Ã—${s.value}\n`;}); document.getElementById('conf-options').innerText=optStr||"ãªã—"; document.getElementById('input-screen').style.display='none'; document.getElementById('price-bar').style.display='none'; document.getElementById('confirm-screen').style.display='block'; window.scrollTo(0,0); }
    function goBack(){ document.getElementById('confirm-screen').style.display='none'; document.getElementById('input-screen').style.display='block'; document.getElementById('price-bar').style.display='flex'; }
    function checkAgreements(){ const b=document.getElementById('finalSubmitBtn'); if(document.getElementById('checkTerms').checked&&document.getElementById('checkAge').checked){b.disabled=false;b.classList.add('active');}else{b.disabled=true;b.classList.remove('active');} }
    
    // â˜…ä¿®æ­£: é€ä¿¡å‰ã«ã€Œæœ€çµ‚ãƒã‚§ãƒƒã‚¯ã€ã‚’è¡Œã†
    function sendToGas(){ 
      const btn=document.getElementById('finalSubmitBtn'); btn.disabled=true; btn.innerText="ç¢ºèªä¸­...";
      
      const ds=fpInstance.selectedDates; const sYMD=formatDateYMD(ds[0]); const eYMD=ds.length>1?formatDateYMD(ds[1]):sYMD;
      const fullS = `${sYMD} ${document.getElementById('startTime').value}:00`;
      const fullE = `${eYMD} ${document.getElementById('endTime').value}:00`;
      const fullRange = `${fullS} ã€œ ${fullE}`;
      const bikeName = document.getElementById('conf-bike').innerText;

      // 1. æœ€çµ‚åœ¨åº«ãƒã‚§ãƒƒã‚¯
      fetch(GAS_URL, {
        method: 'POST', 
        body: JSON.stringify({ action: "check_availability_final", startDate: fullS, endDate: fullE, bikeName: bikeName })
      })
      .then(r => r.json())
      .then(d => {
        if(d.result === 'error') {
          alert("ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚\nã‚¿ãƒƒãƒã®å·®ã§ã€ä»–ã®ãŠå®¢æ§˜ã®äºˆç´„ãŒå…¥ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚\nåˆ¥ã®æ—¥ç¨‹ã‹ã€åˆ¥ã®è»Šä¸¡ã‚’ã”é¸æŠãã ã•ã„ã€‚");
          btn.innerText = "äºˆç´„ç¢ºå®š";
          btn.disabled = false;
          goBack(); // å…¥åŠ›ç”»é¢ã«æˆ»ã™
        } else {
          // 2. å•é¡Œãªã‘ã‚Œã°æœ¬é€ä¿¡
          btn.innerText = "é€ä¿¡ä¸­...";
          const finalData = {
            action:"reserve", userId:lineProfile?lineProfile.userId:"uid", displayName:lineProfile?lineProfile.displayName:"guest",
            regName:document.getElementById('conf-name').innerText, regKana:document.getElementById('regKana').value,
            regPhone:document.getElementById('conf-phone').innerText, regZip:document.getElementById('zipcode').value, regAddress:document.getElementById('regAddress').value,
            dateRange:fullRange, totalDays:document.getElementById('conf-hours').innerText, bikeName:bikeName,
            options:document.getElementById('conf-options').innerText, memo:document.getElementById('memo').value, totalPrice:document.getElementById('conf-price').innerText
          };
          
          fetch(GAS_URL,{method:'POST',body:JSON.stringify(finalData)})
          .then(()=>{ alert("äºˆç´„å®Œäº†ã—ã¾ã—ãŸ"); liff.closeWindow(); })
          .catch(e=>{ alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); btn.disabled=false; });
        }
      });
    }
  </script>
</body>
</html>
