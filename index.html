<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¬ãƒ³ã‚¿ãƒ«äºˆç´„</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/ja.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f4f8; padding: 20px; color: #333; padding-bottom: 120px; }
    .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 400px; margin: 0 auto 20px auto; }
    h2 { text-align: center; font-size: 1.3rem; margin-bottom: 20px; color: #06C755; font-weight: bold; }
    .logo-area { text-align: center; margin-bottom: 20px; font-size: 1.5rem; font-weight: bold; color: #333; }
    
    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
    label { display: block; font-weight: bold; font-size: 0.85rem; margin-bottom: 8px; color: #555; margin-top: 15px; }
    input:not([type="checkbox"]), select, textarea { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; box-sizing: border-box; transition: 0.3s; background: #fff; -webkit-appearance: none; }
    input:focus, select:focus, textarea:focus { border-color: #06C755; outline: none; background-color: #fafffb; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; text-align: center; font-size: 1rem; }
    .btn-primary { background: #06C755; color: white; }
    .btn-secondary { background: #ccc; color: white; }
    .link-text { text-align: center; margin-top: 15px; color: #06C755; text-decoration: underline; cursor: pointer; font-size: 0.9rem; }

    /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
    .screen { display: none; }
    .screen.active { display: block; }

    /* äºˆç´„ç”»é¢ç”¨ */
    .section-title { margin-top: 30px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #eee; font-size: 1.1rem; font-weight: bold; }
    .required::after { content: "å¿…é ˆ"; background: #ff4b4b; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    .optional::after { content: "ä»»æ„"; background: #aaa; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    .zip-group { display: flex; gap: 10px; } .zip-group input { width: 120px; } .zip-group button { width: auto; background: #666; color: white; border:none; border-radius:10px; padding:0 15px; cursor:pointer;}
    .time-container { display: flex; gap: 10px; } .time-group { flex: 1; }
    .time-note { font-size: 0.75rem; color: #d00; margin-top: 4px; }
    .price-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 15px 20px; display:none; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 100; }
    .total-price { font-size: 1.4rem; font-weight: bold; color: #06C755; }
    .btn-submit { background: #06C755; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    
    /* ç”»åƒãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
    #bike-image-container { text-align: center; margin-bottom: 15px; display: none; }
    #bike-image { max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #eee; object-fit: cover; }
    .option-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .option-label { font-size: 0.95rem; flex: 1; }
    .option-price { font-size: 0.85rem; color: #888; margin-right: 10px; }
    .option-select { width: 80px; padding: 8px; margin-bottom: 0; }
    .help-icon { color: #06C755; cursor: pointer; margin-left: 5px; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #descModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
    .desc-content { background: white; padding: 25px; border-radius: 12px; width: 80%; max-width: 300px; text-align: center; }
    .desc-close { background: #333; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; margin-top: 15px; }
    
    /* ç¢ºèªç”»é¢ç”¨ */
    .confirm-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .confirm-table th { text-align: left; padding: 10px; border-bottom: 1px solid #eee; color: #888; width: 35%; }
    .confirm-table td { text-align: right; padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; }
    .confirm-total { text-align: center; margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 10px; }
    .confirm-total-price { font-size: 2rem; color: #06C755; font-weight: bold; }
    .agreement-area { background-color: #fff8f0; border: 1px solid #e0c0a0; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 0.9rem; }
    .agree-item { margin-bottom: 12px; display: flex; align-items: start; }
    .agree-item input { width: 20px; height: 20px; margin-right: 10px; margin-top: 2px; }
  </style>
</head>
<body>
  <div id="loading" style="text-align:center; margin-top:100px; font-weight:bold; color:#666;">ğŸš€ èª­ã¿è¾¼ã¿ä¸­...</div>

  <div id="login-screen" class="screen">
    <div class="card">
      <div class="logo-area">Renta-ãƒ¬ãƒ³ã‚¿-</div>
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" id="login-email">
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="login-pass">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
      <div class="link-text" onclick="showScreen('register-screen')">æ–°è¦ä¼šå“¡ç™»éŒ²ã¯ã“ã¡ã‚‰</div>
    </div>
  </div>

  <div id="register-screen" class="screen">
    <div class="card">
      <h2>æ–°è¦ä¼šå“¡ç™»éŒ²</h2>
      <label class="required">ãŠåå‰</label><input type="text" id="reg-name" placeholder="å±±ç”° å¤ªéƒ">
      <label class="required">ãµã‚ŠãŒãª</label><input type="text" id="reg-kana" placeholder="ã‚„ã¾ã  ãŸã‚ã†">
      <label class="required">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="email" id="reg-email">
      <label class="required">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="reg-pass">
      <label class="required">é›»è©±ç•ªå·</label><input type="tel" id="reg-phone">
      <label class="required">éƒµä¾¿ç•ªå·</label><div class="zip-group"><input type="tel" id="reg-zip" onkeyup="if(this.value.length==7)searchAddress('reg-zip','reg-addr')"><button onclick="searchAddress('reg-zip','reg-addr')">æ¤œç´¢</button></div>
      <label class="required">ä½æ‰€</label><input type="text" id="reg-addr">
      
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="showScreen('login-screen')">æˆ»ã‚‹</button>
        <button class="btn btn-primary" onclick="doRegister()">ç™»éŒ²ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="booking-screen" class="screen">
    <div class="card">
      <div style="text-align:center; margin-bottom:10px;">ã‚ˆã†ã“ã <span id="user-display-name" style="font-weight:bold;">ã‚²ã‚¹ãƒˆ</span> ã•ã‚“</div>
      <h2 id="booking-title">ãƒ¬ãƒ³ã‚¿ãƒ«äºˆç´„</h2>
      
      <div id="guest-form-area">
        <div class="section-title">ãŠå®¢æ§˜æƒ…å ±</div>
        <label class="required">ãŠåå‰</label><input type="text" id="bk-name">
        <label class="required">ãµã‚ŠãŒãª</label><input type="text" id="bk-kana">
        <label class="required">é›»è©±ç•ªå·</label><input type="tel" id="bk-phone">
        <label class="optional">éƒµä¾¿ç•ªå·</label><div class="zip-group"><input type="tel" id="bk-zip"><button onclick="searchAddress('bk-zip','bk-address')">æ¤œç´¢</button></div>
        <label class="required">ä½æ‰€</label><input type="text" id="bk-address">
      </div>

      <div class="section-title">ã”äºˆç´„å†…å®¹</div>
      <label class="required">ã”åˆ©ç”¨æœŸé–“</label><input type="text" id="dateRange" class="calendar-input" placeholder="æœŸé–“ã‚’é¸æŠ" readonly>
      <div class="time-container">
        <div class="time-group"><label class="required">è²¸æ¸¡æ™‚é–“</label><select id="startTime" onchange="calcTotal()"></select></div>
        <div class="time-group"><label class="required">è¿”å´æ™‚é–“</label><select id="endTime" onchange="calcTotal()"></select></div>
      </div>
      <div id="days-display" style="text-align:right; font-size:0.8rem; color:#888; margin-top:4px;">0æ™‚é–“</div>
      <div class="time-note">â€»18:00ä»¥é™ã®è¿”å´ã¯ç„¡äººè¿”å´BOXã®ã”åˆ©ç”¨ã¨ãªã‚Šã¾ã™ã€‚<br>â€»æœ¨æ›œæ—¥ã¯å®šä¼‘æ—¥ã®ãŸã‚è²¸å‡ºï¼ˆå‡ºç™ºï¼‰ã¯ã§ãã¾ã›ã‚“ã€‚</div>

      <label class="required">æ’æ°—é‡ã‚¯ãƒ©ã‚¹</label><select id="classSelect" onchange="updateBikeList()"><option value="">èª­ã¿è¾¼ã¿ä¸­...</option></select>
      <label class="required">è»Šç¨®é¸æŠ</label><select id="bikeSelect" onchange="showBikeImage(); calcTotal();" disabled><option value="0">å…ˆã«ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option></select>
      <div id="bike-image-container"><img id="bike-image" src="" alt=""></div>

      <label>ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠ (1æ—¥ã‚ãŸã‚Š)</label><div id="optionArea"></div>
      <label>å‚™è€ƒ</label><textarea id="memo"></textarea><div style="height: 60px;"></div>
    </div>
  </div>

  <div id="confirm-screen" class="screen">
    <div class="card">
      <h2>ã”äºˆç´„å†…å®¹ã®ç¢ºèª</h2>
      <div class="section-title">ãŠå®¢æ§˜æƒ…å ±</div>
      <table class="confirm-table"><tr><th>ãŠåå‰</th><td id="conf-name"></td></tr><tr><th>é›»è©±ç•ªå·</th><td id="conf-phone"></td></tr></table>
      <div class="section-title">äºˆç´„å†…å®¹</div>
      <table class="confirm-table">
        <tr><th>æœŸé–“</th><td id="conf-date" style="font-size:0.9rem;"></td></tr>
        <tr><th>æ™‚é–“</th><td id="conf-time"></td></tr>
        <tr><th>åˆ©ç”¨æ™‚é–“</th><td id="conf-hours"></td></tr>
        <tr><th>ãƒã‚¤ã‚¯</th><td id="conf-bike" style="font-size:0.9rem;"></td></tr>
        <tr><th>é©ç”¨ãƒ—ãƒ©ãƒ³</th><td id="conf-plan" style="font-size:0.8rem;"></td></tr>
        <tr><th>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</th><td id="conf-options" style="font-size:0.8rem;"></td></tr>
      </table>
      <div class="confirm-total"><div class="confirm-total-label">ãŠæ”¯æ‰•ã„äºˆå®šç·é¡</div><div class="confirm-total-price" id="conf-price">Â¥0</div></div>
      <div class="agreement-area">
        <div style="font-weight:bold; margin-bottom:10px; text-align:center;">âš ï¸ é‡è¦äº‹é …ã®ç¢ºèª</div>
        <label class="agree-item"><input type="checkbox" id="checkTerms" onchange="checkAgreements()"><span>åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¾ã™ã€‚</span></label>
        <label class="agree-item"><input type="checkbox" id="checkAge" onchange="checkAgreements()"><span>18æ­³ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ã‚’èª“ç´„ã—ã¾ã™ã€‚</span></label>
      </div>
      <div class="btn-group"><button class="btn btn-secondary" onclick="showScreen('booking-screen')">ä¿®æ­£ã™ã‚‹</button><button class="btn btn-primary" id="finalSubmitBtn" onclick="sendToGas()" disabled>äºˆç´„ç¢ºå®š</button></div>
    </div>
  </div>

  <div class="price-bar" id="price-bar"><div><div style="font-size:0.8rem; color:#555;">ãŠæ”¯æ‰•ã„äºˆå®šé¡</div><div class="total-price" id="totalPriceDisplay">Â¥0</div></div><button class="btn-submit" onclick="showConfirm()">ç¢ºèªã¸é€²ã‚€</button></div>

  <div id="descModal"><div class="desc-content"><div class="desc-title" id="desc-title"></div><div class="desc-text" id="desc-text"></div><button class="desc-close" onclick="document.getElementById('descModal').style.display='none'">é–‰ã˜ã‚‹</button></div></div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxWvKydNXGLMLBDXLkigRBnJJeJgRLttFlruTFbDLCFNaKagLONSf_9JOT9hXjFaup_9w/exec";
    const MY_LIFF_ID = "2008826232-lvGwqtl1";

    let masterData = { categories: [], options: [] };
    let allReservations = []; 
    let fpInstance; 
    let lineProfile = null; 
    let currentUser = null; // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

    // â˜… åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼
    window.onload = function() {
      // 1. ãƒã‚¹ã‚¿ã¨äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’è£ã§å–å¾—é–‹å§‹
      fetchMasterData();

      // 2. LIFF (LINE) ã‹ Web ã‹ã‚’åˆ¤å®š
      liff.init({ liffId: MY_LIFF_ID }).then(() => {
        if (liff.isLoggedIn()) {
          // LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ -> ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã€å³äºˆç´„ç”»é¢ã¸
          liff.getProfile().then(p => {
            lineProfile = p;
            document.getElementById('user-display-name').innerText = p.displayName;
            // éå»ã®åˆ©ç”¨å±¥æ­´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦è‡ªå‹•å…¥åŠ›
            checkUserStatus(p.userId);
            showScreen('booking-screen');
          });
        } else {
          // Webãƒ¦ãƒ¼ã‚¶ãƒ¼ -> ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ (è‡ªå‹•é·ç§»ã—ãªã„)
          document.getElementById('loading').style.display = 'none';
          showScreen('login-screen');
        }
      }).catch(e => {
        // LIFFåˆæœŸåŒ–å¤±æ•—(PCãªã©) -> ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
        document.getElementById('loading').style.display = 'none';
        showScreen('login-screen');
      });

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç­‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      fpInstance = flatpickr("#dateRange", { mode: "range", minDate: "today", dateFormat: "Y-m-d", locale: "ja", disableMobile: "true", onClose: function(sd){ if(sd.length>0&&sd[0].getDay()===4){alert("æœ¨æ›œæ—¥ã¯å®šä¼‘æ—¥ã®ãŸã‚è²¸å‡ºä¸å¯ã§ã™");fpInstance.clear();return;} calcTotal(); checkAvailability(); } });
      generateTimeOptions('startTime', 9, 18); generateTimeOptions('endTime', 0, 23);
    };

    // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      
      // äºˆç´„ç”»é¢ãªã‚‰ä¾¡æ ¼ãƒãƒ¼ã‚’è¡¨ç¤º
      if(id === 'booking-screen') document.getElementById('price-bar').style.display = 'flex';
      else document.getElementById('price-bar').style.display = 'none';
      
      window.scrollTo(0,0);
    }

    // --- ä¼šå“¡æ©Ÿèƒ½ ---
    function doLogin() {
      const email = document.getElementById('login-email').value;
      const pass = document.getElementById('login-pass').value;
      if(!email || !pass) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
      
      fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "login_member", email: email, password: pass }) })
      .then(r => r.json()).then(d => {
        if(d.result === 'success') {
          currentUser = d.userData;
          // äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›
          document.getElementById('bk-name').value = currentUser.regName;
          document.getElementById('bk-kana').value = currentUser.regKana;
          document.getElementById('bk-phone').value = currentUser.regPhone;
          document.getElementById('bk-zip').value = currentUser.regZip;
          document.getElementById('bk-address').value = currentUser.regAddress;
          document.getElementById('user-display-name').innerText = currentUser.regName;
          
          alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ");
          showScreen('booking-screen');
        } else {
          alert(d.message);
        }
      });
    }

    function doRegister() {
      const d = {
        action: "register_member",
        name: document.getElementById('reg-name').value,
        kana: document.getElementById('reg-kana').value,
        email: document.getElementById('reg-email').value,
        password: document.getElementById('reg-pass').value,
        phone: document.getElementById('reg-phone').value,
        zip: document.getElementById('reg-zip').value,
        address: document.getElementById('reg-addr').value
      };
      if(!d.name || !d.email || !d.password) return alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      
      fetch(GAS_URL, { method: 'POST', body: JSON.stringify(d) })
      .then(r => r.json()).then(res => {
        if(res.result === 'success') {
          alert("ç™»éŒ²ã—ã¾ã—ãŸï¼\nãƒ­ã‚°ã‚¤ãƒ³ã—ã¦äºˆç´„ã¸ãŠé€²ã¿ãã ã•ã„ã€‚");
          showScreen('login-screen');
        } else {
          alert("ã‚¨ãƒ©ãƒ¼: " + res.message);
        }
      });
    }

    // --- äºˆç´„é–¢é€£ (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯çµ±åˆ) ---
    function checkUserStatus(uid){ fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:"check",userId:uid})}).then(r=>r.json()).then(d=>{if(d.result==='found'){const u=d.userData;document.getElementById('bk-name').value=u.regName;document.getElementById('bk-kana').value=u.regKana;document.getElementById('bk-phone').value=u.regPhone;document.getElementById('bk-zip').value=u.regZip;document.getElementById('bk-address').value=u.regAddress;}});}
    
    function fetchMasterData() { fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "get_master_data" }) }).then(r=>r.json()).then(d=>{ if (d.result === 'success') { masterData.categories = d.categories; masterData.options = d.options; initClassSelect(); initOptionSelect(); fetchAllReservations(); } }); }
    function fetchAllReservations() { fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "get_reserved_ranges" }) }).then(r=>r.json()).then(d=>{ if(d.result === 'success') { allReservations = d.data; document.getElementById('loading').style.display='none'; } }); } // ãƒ­ãƒ¼ãƒ‰å®Œäº†ã¯å€‹åˆ¥åˆ¶å¾¡ã¸
    
    function safeParseInt(val) { if (!val) return 0; const num = parseInt(val); return isNaN(num) ? 0 : num; }
    function calculatePrice(rates, hours) { const p4=safeParseInt(rates.p4),p8=safeParseInt(rates.p8),p24=safeParseInt(rates.p24),pAdd=safeParseInt(rates.pAdd); if(hours<=4)return p4;else if(hours<=8)return p8;else if(hours<=24)return p24;else{return p24+(pAdd*Math.ceil((hours-24)/24));} }
    
    function showBikeImage() { const s=document.getElementById('bikeSelect'); const c=document.getElementById('bike-image-container'); const i=document.getElementById('bike-image'); if(s.value!=="0"){const u=s.options[s.selectedIndex].dataset.image; if(u){i.src=u;c.style.display="block";}else{c.style.display="none";}}else{c.style.display="none";} }
    function showDesc(t,tx){ document.getElementById('desc-title').innerText=t; document.getElementById('desc-text').innerText=tx; document.getElementById('descModal').style.display='flex'; }

    function initClassSelect() { const s=document.getElementById('classSelect'); s.innerHTML='<option value="">ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>'; masterData.categories.forEach((c,i)=>{const o=document.createElement('option');o.value=i;o.textContent=c.name;s.appendChild(o);}); }
    function initOptionSelect() { const a=document.getElementById('optionArea'); a.innerHTML=""; masterData.options.forEach(o=>{ const div=document.createElement('div');div.className='option-row'; const help=o.desc?`<span class="help-icon" onclick="showDesc('${o.name}','${o.desc}')">(?)</span>`:""; div.innerHTML=`<div class="option-label">${o.name} ${help}</div><div class="option-price">ç›®å®‰: +Â¥${safeParseInt(o.p24).toLocaleString()}/æ—¥</div><select class="option-select" data-p4="${o.p4}" data-p8="${o.p8}" data-p24="${o.p24}" data-p-add="${o.pAdd}" data-name="${o.name}" onchange="calcTotal()"><option value="0">ãªã—</option><option value="1">1</option><option value="2">2</option></select>`; a.appendChild(div); }); }
    function updateBikeList(busy=[]) { const idx=document.getElementById('classSelect').value; const bs=document.getElementById('bikeSelect'); const cur=bs.value; bs.innerHTML='<option value="0">é¸æŠã—ã¦ãã ã•ã„</option>'; if(idx===""){bs.disabled=true;return;} masterData.categories[idx].bikes.forEach(b=>{ const o=document.createElement('option');o.value=b.name;o.dataset.p4=b.p4;o.dataset.p8=b.p8;o.dataset.p24=b.p24;o.dataset.pAdd=b.pAdd;o.dataset.image=b.image||""; if(busy.includes(b.name)){o.disabled=true;o.textContent=`âŒ ${b.name} (è²¸å‡ºä¸­)`;}else{o.textContent=b.name;} bs.appendChild(o); }); bs.disabled=false; if(cur&&!busy.includes(cur))bs.value=cur; showBikeImage(); calcTotal(); }
    
    function checkAvailability() { const d=fpInstance.selectedDates; if(d.length===0)return; const s=new Date(d[0]); s.setHours(document.getElementById('startTime').value); const e=new Date(d.length>1?d[1]:d[0]); e.setHours(document.getElementById('endTime').value); let busy=[]; allReservations.forEach(r=>{if(s<new Date(r.end)&&e>new Date(r.start))busy.push(r.bike);}); updateBikeList([...new Set(busy)]); }
    function calcTotal() { const d=fpInstance.selectedDates; if(d.length===0)return; const s=new Date(d[0]);s.setHours(document.getElementById('startTime').value); const e=new Date(d.length>1?d[1]:d[0]);e.setHours(document.getElementById('endTime').value); let diff=(e-s)/(1000*60*60); if(diff<=0){document.getElementById('days-display').innerText="æ—¥æ™‚ã‚¨ãƒ©ãƒ¼"; return;} document.getElementById('days-display').innerText=`åˆ©ç”¨æ™‚é–“: ${diff}æ™‚é–“`; const bs=document.getElementById('bikeSelect'); let bTotal=0,plan=""; if(bs.value!=="0"){bTotal=calculatePrice(bs.options[bs.selectedIndex].dataset,diff); if(diff<=4)plan="4æ™‚é–“";else if(diff<=8)plan="8æ™‚é–“";else if(diff<=24)plan="24æ™‚é–“";else plan="24æ™‚é–“+è¿½åŠ ";} let oTotal=0; document.querySelectorAll('.option-select').forEach(sel=>{if(sel.value>0)oTotal+=calculatePrice(sel.dataset,diff)*sel.value;}); document.getElementById('totalPriceDisplay').innerText="Â¥"+(bTotal+oTotal).toLocaleString(); document.getElementById('conf-plan').innerText=plan; document.getElementById('conf-hours').innerText=diff+"æ™‚é–“"; }
    
    function generateTimeOptions(id,s,e){const el=document.getElementById(id);for(let i=s;i<=e;i++){const o=document.createElement('option');o.value=i;o.text=i+":00";if(id==='startTime'&&i===10)o.selected=true;if(id==='endTime'&&i===18)o.selected=true;el.appendChild(o);}}
    function searchAddress(zId,aId){const z=document.getElementById(zId).value;fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${z}`).then(r=>r.json()).then(d=>{if(d.results)document.getElementById(aId).value=d.results[0].address1+d.results[0].address2+d.results[0].address3;else alert("ä½æ‰€ä¸æ˜");});}

    function showConfirm(){
      const nm=document.getElementById('bk-name').value; const ph=document.getElementById('bk-phone').value; if(!nm||!ph){alert("ãŠå®¢æ§˜æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
      if(fpInstance.selectedDates.length===0){alert("æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„");return;} if(document.getElementById('bikeSelect').value==="0"){alert("ãƒã‚¤ã‚¯ã‚’é¸æŠ");return;}
      document.getElementById('conf-name').innerText=nm; document.getElementById('conf-phone').innerText=ph;
      document.getElementById('conf-date').innerText=document.getElementById('dateRange').value;
      document.getElementById('conf-time').innerText=`${document.getElementById('startTime').value}:00 ã€œ ${document.getElementById('endTime').value}:00`;
      document.getElementById('conf-bike').innerText=document.getElementById('bikeSelect').value;
      document.getElementById('conf-price').innerText=document.getElementById('totalPriceDisplay').innerText;
      let opt=""; document.querySelectorAll('.option-select').forEach(s=>{if(s.value>0)opt+=`${s.dataset.name}Ã—${s.value}\n`;});
      document.getElementById('conf-options').innerText=opt||"ãªã—";
      showScreen('confirm-screen');
    }

    function sendToGas(){
      const btn=document.getElementById('finalSubmitBtn'); btn.disabled=true; btn.classList.add('sending'); btn.innerText="é€ä¿¡ä¸­...";
      const ds=fpInstance.selectedDates; const sYMD=`${ds[0].getFullYear()}/${ds[0].getMonth()+1}/${ds[0].getDate()}`; const eDate=ds.length>1?ds[1]:ds[0]; const eYMD=`${eDate.getFullYear()}/${eDate.getMonth()+1}/${eDate.getDate()}`;
      const fullS=`${sYMD} ${document.getElementById('startTime').value}:00`; const fullE=`${eYMD} ${document.getElementById('endTime').value}:00`;
      const bikeName=document.getElementById('conf-bike').innerText;
      
      // æœ€çµ‚ãƒã‚§ãƒƒã‚¯
      fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:"check_availability_final",startDate:fullS,endDate:fullE,bikeName:bikeName})})
      .then(r=>r.json()).then(d=>{
        if(d.result==='error'){ alert("ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¿ãƒƒãƒã®å·®ã§äºˆç´„ãŒåŸ‹ã¾ã‚Šã¾ã—ãŸã€‚"); btn.disabled=false; btn.classList.remove('sending'); btn.innerText="äºˆç´„ç¢ºå®š"; showScreen('booking-screen'); }
        else {
          // äºˆç´„é€ä¿¡
          const finalData = {
            action:"reserve", 
            userId: lineProfile ? lineProfile.userId : "uid", // LINEä»¥å¤–ã¯ä»®ID
            displayName: lineProfile ? lineProfile.displayName : document.getElementById('bk-name').value,
            regName: document.getElementById('bk-name').value,
            regKana: document.getElementById('bk-kana').value,
            regPhone: document.getElementById('bk-phone').value,
            regZip: document.getElementById('bk-zip').value,
            regAddress: document.getElementById('bk-address').value,
            email: currentUser ? currentUser.email : (document.getElementById('reg-email') ? document.getElementById('reg-email').value : ""), // ãƒ¡ã‚¢ãƒ‰é€ä¿¡
            dateRange: `${fullS} ã€œ ${fullE}`, totalDays: document.getElementById('conf-hours').innerText,
            bikeName: bikeName, options: document.getElementById('conf-options').innerText,
            memo: document.getElementById('memo').value, totalPrice: document.getElementById('conf-price').innerText
          };
          fetch(GAS_URL,{method:'POST',body:JSON.stringify(finalData)}).then(()=>{ alert("äºˆç´„å®Œäº†ã—ã¾ã—ãŸ"); if(lineProfile) liff.closeWindow(); else location.reload(); })
          .catch(()=>{alert("ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ");btn.disabled=false;btn.classList.remove('sending');btn.innerText="äºˆç´„ç¢ºå®š";});
        }
      });
    }
  </script>
</body>
</html>
